---
sidebar: sidebar 
permalink: containers/anthos_task_deploy_additional_user_clusters.html 
summary: 借助 Anthos ，企业可以扩展其环境，以整合多个用户集群并在各个团队之间隔离工作负载。一个管理集群最多可支持五个用户集群，每个用户集群最多可支持二十五个节点。要将其他用户集群添加到您的部署中，请完成此页面上列出的步骤。 
keywords: VM, kubect1, kebeconfig 
---
= 9. 部署其他用户集群：采用 Anthos 的 NetApp HCI


[role="lead"]
借助 Anthos ，企业可以扩展其环境，以整合多个用户集群并在各个团队之间隔离工作负载。一个管理集群最多可支持五个用户集群，每个用户集群最多可支持二十五个节点。

要将其他用户集群添加到您的部署中，请完成以下步骤：

. 将 `config.yaml` 文件复制到名为 `anthos-cluster02-config.yaml` 的新文件中。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ cp config.yaml anthos-cluster02-config.yaml
----
. 对新创建的文件进行以下编辑：
+
.. 使用（ # ）注释掉有关现有管理集群的章节。
.. 进入 `usercluster` 部分后，更新以下字段：
+
... 更新 `bigip` 部分下的分区名称。
... 更新 `VIP` 部分下的 `controlplanvip` 和 `ingressvip` 值。
... 更新 `clustername` 值。
+
[listing]
----
 usercluster:
  # In-Cluster vCenter configuration
  vcenter:
    # If specified it overwrites the network field in global vcenter configuration
    network: ""
  # # The absolute or relative path to the yaml file to use for static IP allocation.
  # # Do not include if using DHCP
  # ipblockfilepath: ""
  # # Specify pre-defined nodeports if using "manual" load balancer mode
  # manuallbspec:
  #   ingresshttpnodeport: 30243
  #   ingresshttpsnodeport: 30879
  #   controlplanenodeport: 30562
  #   addonsnodeport: 0
  # Specify the already-existing partition and credentials to use with F5
  bigip:
    # To re-use credentials across clusters we recommend using YAML node anchors.
    # See https://yaml.org/spec/1.2/spec.html#id2785586
    credentials:
      address: "172.21.224.22"
      username: "admin"
      password: "NetApp!23"
    partition: "Anthos-Cluster02-Part"
    # # Optionally specify a pool name if using SNAT
    # snatpoolname: ""
  # The VIPs to use for load balancing
  vips:
    # Used to connect to the Kubernetes API
    controlplanevip: "10.63.172.108"
    # Shared by all services for ingress traffic
    ingressvip: "10.63.172.109"
    # # Used for admin cluster addons (needed for multi cluster features). Must be the same
    # # across clusters
    # addonsvip: ""
  # A unique name for this cluster
  clustername: "anthos-cluster02"
  # User cluster master nodes must have either 1 or 3 replicas
  masternode:
    cpus: 4
    memorymb: 8192
    # How many machines of this type to deploy
    replicas: 1
  # The number of worker nodes to deploy and their size. Min. 2 replicas
  workernode:
    cpus: 4
    memorymb: 8192
    # How many machines of this type to deploy
    replicas: 3
  # The Kubernetes service CIDR range for the cluster
  serviceiprange: 10.96.0.0/12
  # The Kubernetes pod CIDR range for the cluster
  podiprange: 192.168.0.0/16
----




. 运行以下命令以再次检查配置文件，以验证是否没有语法错误。由于已删除 admin 部分，因此您必须参考名为 `kubeconfig` 的管理集群的 `kubeconfig` 文件（位于工作目录中）。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ gkectl check-config --config anthos-cluster02-config.yaml --kubeconfig kubeconfig
- Validation Category: Config Check
    - [SUCCESS] Config

- Validation Category: Docker Registry
    - [SUCCESS] gcr.io/gke-on-prem-release access

- Validation Category: vCenter
    - [SUCCESS] Credentials
    - [SUCCESS] Datacenter
    - [SUCCESS] Datastore
    - [FAILURE] Data Disk: vCenter data disk already exists
    - [SUCCESS] Resource Pool
    - [SUCCESS] Network

- Validation Category: F5 BIG-IP
    - [SUCCESS] Credentials
    - [SUCCESS] Partition

- Validation Category: Network Configuration
    - [SUCCESS] CIDR, VIP and static IP (availability and overlapping)

- Validation Category: VIPs
    - [SUCCESS] ping (availability)

- Validation Category: Node IPs
    - [SUCCESS] ping (availability)

Some validations FAILED or SKIPPED. Check report above.
----
. 如果所有检查均按预期成功，则可以参考管理集群中的 `kubeconfig` 文件，以与首次创建集群非常相似的方式部署此新用户集群。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ gkectl create cluster --config anthos-cluster02-config.yaml --kubeconfig kubeconfig
----
. 与先前的部署一样，此过程会运行几分钟，并可在屏幕上和 vCenter 中通过在 VM 填充时监控资源池来进行监控。完成后，您应该能够看到新的用户集群（四个节点）。
+
image::new_user_cluster.PNG[请参见新用户集群。]

. 您可以使用 kubectl 命令行工具和进程生成的 `kubeconfig` 文件（存储在工作目录中）对已部署的用户集群访问和执行命令。
+
[listing]
----
ubuntu@Anthos-Admin-Workstation:~$ kubectl get nodes --kubeconfig anthos-cluster02-kubeconfig
NAME                                STATUS   ROLES    AGE     VERSION
anthos-cluster02-84744f5bd8-8rqk6   Ready    <none>   9m16s   v1.13.7-gke.20
anthos-cluster02-84744f5bd8-fl786   Ready    <none>   9m28s   v1.13.7-gke.20
anthos-cluster02-84744f5bd8-fnsmp   Ready    <none>   9m21s   v1.13.7-gke.20
----

