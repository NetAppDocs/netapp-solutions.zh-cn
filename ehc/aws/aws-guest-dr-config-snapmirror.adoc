---
sidebar: sidebar 
permalink: ehc/aws/aws-guest-dr-config-snapmirror.html 
keywords: Intercluster logical interfaces, cluster peering, SVM peering, snapshot retention policy, destination volumes, SnapMirror relationships 
summary: 'SnapCenter 可以更新主存储系统(主存储系统>镜像)和二级存储系统(主存储系统>存储)中的SnapMirror关系、以便进行长期归档和保留。为此、您必须使用SnapMirror在目标卷和源卷之间建立并初始化数据复制关系。' 
---
= 配置SnapMirror关系和保留计划
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../../media/


link:aws-guest-dr-snapcenter-overview.html["先前版本：概述—灾难恢复。"]

SnapCenter 可以更新主存储系统(主存储系统>镜像)和二级存储系统(主存储系统>存储)中的SnapMirror关系、以便进行长期归档和保留。为此、您必须使用SnapMirror在目标卷和源卷之间建立并初始化数据复制关系。

源和目标ONTAP 系统必须位于使用Amazon VPC对等、传输网关、AWS Direct Connect或AWS VPN建立对等关系的网络中。

要在内部ONTAP 系统和FSX ONTAP 之间设置SnapMirror关系、需要执行以下步骤：

* 记录源和目标集群间逻辑接口。
* 在ONTAP 和FSX之间建立集群对等关系。
* 建立SVM对等关系。
* 创建快照保留策略。
* 在FSX中创建目标卷。
* 在源卷和目标卷之间创建SnapMirror关系。
* 初始化SnapMirror关系。


请参见 https://docs.aws.amazon.com/fsx/latest/ONTAPGuide/ONTAPGuide.pdf["适用于ONTAP 的FSx—ONTAP 用户指南"^] 有关使用FSX创建SnapMirror关系的详细信息、请参见。



== 记录源和目标集群间逻辑接口

对于驻留在内部的源ONTAP 系统、您可以从System Manager或命令行界面检索集群间LIF信息。

. 在ONTAP 系统管理器中、导航到"网络概述"页面、然后检索类型为"集群间"的IP地址、这些IP地址配置为与安装了FSX的AWS VPC进行通信。
+
image:dr-vmc-aws-image10.png["错误：缺少图形映像"]

. 要检索FSX的集群间IP地址、请登录到命令行界面并运行以下命令：
+
....
FSx-Dest::> network interface show -role intercluster
....
+
image:dr-vmc-aws-image11.png["错误：缺少图形映像"]





== 在ONTAP 和FSX之间建立集群对等关系

要在ONTAP 集群之间建立集群对等关系、必须在另一对等集群中确认在发起ONTAP 集群上输入的唯一密码短语。

. 使用`cluster peer create`命令在目标FSX集群上设置对等关系。出现提示时、输入一个唯一的密码短语、稍后在源集群上使用该密码短语以完成创建过程。
+
....
FSx-Dest::> cluster peer create -address-family ipv4 -peer-addrs source_intercluster_1, source_intercluster_2
Enter the passphrase:
Confirm the passphrase:
....
. 在源集群上、您可以使用ONTAP 系统管理器或命令行界面建立集群对等关系。在ONTAP 系统管理器中、导航到"保护">"概述"、然后选择"对等集群"。
+
image:dr-vmc-aws-image12.png["错误：缺少图形映像"]

. 在对等集群对话框中、填写所需信息：
+
.. 输入用于在目标FSX集群上建立对等集群关系的密码短语。
.. 选择`是`以建立加密关系。
.. 输入目标FSX集群的集群间LIF IP地址。
.. 单击启动集群对等以完成此过程。
+
image:dr-vmc-aws-image13.png["错误：缺少图形映像"]



. 使用以下命令从FSX集群验证集群对等关系的状态：
+
....
FSx-Dest::> cluster peer show
....
+
image:dr-vmc-aws-image14.png["错误：缺少图形映像"]





== 建立SVM对等关系

下一步是在目标和源Storage Virtual Machine之间设置SVM关系、这些虚拟机包含将处于SnapMirror关系中的卷。

. 在源FSX集群中、从CLI使用以下命令创建SVM对等关系：
+
....
FSx-Dest::> vserver peer create -vserver DestSVM -peer-vserver Backup -peer-cluster OnPremSourceSVM -applications snapmirror
....
. 在源ONTAP 集群中、接受与ONTAP 系统管理器或命令行界面的对等关系。
. 在ONTAP 系统管理器中、转到"保护">"概述"、然后在"Storage VM对等方"下选择"对等Storage VM"。
+
image:dr-vmc-aws-image15.png["错误：缺少图形映像"]

. 在对等Storage VM的对话框中、填写必填字段：
+
** 源Storage VM
** 目标集群
** 目标Storage VM
+
image:dr-vmc-aws-image16.png["错误：缺少图形映像"]



. 单击对等Storage VM以完成SVM对等过程。




== 创建快照保留策略

SnapCenter 管理主存储系统上作为Snapshot副本存在的备份的保留计划。这是在SnapCenter 中创建策略时建立的。SnapCenter 不会管理二级存储系统上保留的备份的保留策略。这些策略通过在二级FSX集群上创建的SnapMirror策略单独管理、并与与与源卷具有SnapMirror关系的目标卷相关联。

创建SnapCenter 策略时、您可以选择指定一个二级策略标签、该标签将添加到创建SnapCenter 备份时生成的每个快照的SnapMirror标签中。


NOTE: 在二级存储上、这些标签与与与目标卷关联的策略规则匹配、以便强制保留快照。

以下示例显示了一个SnapMirror标签、该标签位于作为SQL Server数据库和日志卷每日备份策略一部分生成的所有快照上。

image:dr-vmc-aws-image17.png["错误：缺少图形映像"]

有关为SQL Server数据库创建SnapCenter 策略的详细信息、请参见 https://docs.netapp.com/us-en/snapcenter/protect-scsql/task_create_backup_policies_for_sql_server_databases.html["SnapCenter 文档"^]。

您必须先创建一个SnapMirror策略、其中包含指定要保留的Snapshot副本数量的规则。

. 在FSX集群上创建SnapMirror策略。
+
....
FSx-Dest::> snapmirror policy create -vserver DestSVM -policy PolicyName -type mirror-vault -restart always
....
. 向策略添加SnapMirror标签与SnapCenter 策略中指定的二级策略标签匹配的规则。
+
....
FSx-Dest::> snapmirror policy add-rule -vserver DestSVM -policy PolicyName -snapmirror-label SnapMirrorLabelName -keep #ofSnapshotsToRetain
....
+
以下脚本提供了可添加到策略中的规则示例：

+
....
FSx-Dest::> snapmirror policy add-rule -vserver sql_svm_dest -policy Async_SnapCenter_SQL -snapmirror-label sql-ondemand -keep 15
....
+

NOTE: 为每个SnapMirror标签以及要保留的快照数量(保留期限)创建其他规则。





== 创建目标卷

要在FSX上创建一个目标卷、使其成为源卷中Snapshot副本的收件人、请在FSX ONTAP 上运行以下命令：

....
FSx-Dest::> volume create -vserver DestSVM -volume DestVolName -aggregate DestAggrName -size VolSize -type DP
....


== 在源卷和目标卷之间创建SnapMirror关系

要在源卷和目标卷之间创建SnapMirror关系、请在FSX ONTAP 上运行以下命令：

....
FSx-Dest::> snapmirror create -source-path OnPremSourceSVM:OnPremSourceVol -destination-path DestSVM:DestVol -type XDP -policy PolicyName
....


== 初始化SnapMirror关系

初始化SnapMirror关系。此过程将启动从源卷生成的新快照、并将其复制到目标卷。

要创建卷、请在FSX ONTAP 上运行以下命令：

....
FSx-Dest::> volume create -vserver DestSVM -volume DestVolName -aggregate DestAggrName -size VolSize -type DP
....
link:aws-guest-dr-config-snapcenter.html["接下来：在内部部署和配置Windows SnapCenter 服务器。"]
