---
sidebar: sidebar 
permalink: virtualization/vsphere_ontap_auto_file_nfs.html 
keywords: vSphere, datastore, nfs, ONTAP tools, vlan, network interface, service policy, export policy 
summary: 此页面提供了在 VMware vSphere 环境中部署 NetApp ONTAP NFS 版本 3 数据存储库的步骤。 
---
= vSphere NFS 数据存储库—使用 ONTAP 的版本 3
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/
:scriptsdir: ./../scripts/
:author: Suresh Thoppay, TME - Hybrid Cloud Solutions
:ontap_version: ONTAP 9.8 or later
:vsphere_version: vSphere 7.0 or later
:includesdir: ./../
:firstname: Suresh
:authorinitials: STT
:middlename: Thoppay,
:lastname: TME - Hybrid Cloud Solutions
:authors: Suresh Thoppay, TME - Hybrid Cloud Solutions




== 关于此任务

使用 ONTAP NAS 存储创建 NFS 版本 3 数据存储库。

对于自动配置，请使用以下脚本之一： <<PowerShell>>， <<Ansible>>或 <<Terraform>>。



== 您需要的内容

* 管理 vSphere 环境和 ONTAP 所需的基本技能。
* 运行 ONTAP 9.8 或更高版本的 ONTAP 存储系统（ FAS/AFF/CVO/ONTAP Select/Cloud Volume Service/Azure NetApp Files ）
* ONTAP 凭据（ SVM 名称，用户 ID ，密码）
* NFS 的 ONTAP 网络端口， SVM 和 LUN 信息
+
** link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-nfs-vaai/GUID-BBD301EF-496A-4974-B205-5F878E44BF59.html++["完整的 NFS 配置工作表"]


* vCenter Server 凭据
* vSphere 7.0 或更高版本的 vSphere 主机信息
* NFS VMKernel 适配器 IP 信息
* 网络交换机
+
** 使用 ONTAP 系统网络数据端口并连接 vSphere 主机
** 为 NFS 配置的 VLAN
** （可选）为 ONTAP 网络数据端口配置的链路聚合


* 适用于 VMware vSphere 的 ONTAP 工具已部署，配置并可随时使用




== 步骤

* 检查与的兼容性 https://mysupport.netapp.com/matrix["互操作性表工具（ IMT ）"]
+
** link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-nfs-vaai/GUID-DA231492-F8D1-4E1B-A634-79BA906ECE76.html++["验证是否支持 NFS 配置。"]


* 完成以下 ONTAP 和 vSphere 任务。




== ONTAP 任务

. link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-cmpr-980/system__license__show.html++["验证 NFS 的 ONTAP 许可证。"]
+
.. 使用 `ssystem license show` 命令检查是否已列出 NFS 。
.. 使用 `license add -license-code < 许可证代码 >` 添加许可证。


. link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nfs-cg/GUID-6D7A1BB1-C672-46EF-B3DC-08EBFDCE1CD5.html++["按照 NFS 配置工作流进行操作。"]




== VMware vSphere 任务

link:++https://docs.netapp.com/ontap-9/topic/com.netapp.doc.exp-nfs-vaai/GUID-D78DD9CF-12F2-4C3C-AD3A-002E5D727411.html++["按照适用于 vSphere 的 NFS 客户端配置工作流进行操作。"]



== 参考

通过 vSphere ，客户可以使用企业级 NFS 阵列为 ESXi 集群中的所有节点提供对数据存储库的并发访问。如数据存储库一节所述，在将 NFS 与 vSphere 结合使用时，可以获得一些易用性和存储效率可见性优势。

将 ONTAP NFS 与 vSphere 结合使用时，建议采用以下最佳实践：

* 为 ONTAP 集群中每个节点上的每个 SVM 使用一个逻辑接口（ LIF ）。不再需要以往为每个数据存储库建议的 LIF 。虽然直接访问（ LIF 和同一节点上的数据存储库）是最佳选择，但不要担心间接访问，因为通常对性能的影响极小（微秒）。
* 自 VMware Infrastructure 3 以来， VMware 一直支持 NFSv3 。vSphere 6.0 增加了对 NFSv4.1 的支持，该支持可实现 Kerberos 安全性等一些高级功能。如果 NFSv3 使用客户端锁定，则 NFSv4.1 使用服务器端锁定。虽然 ONTAP 卷可以通过这两种协议导出，但 ESXi 只能通过一种协议挂载。此单协议挂载并不会阻止其他 ESXi 主机通过不同版本挂载同一数据存储库。请务必指定挂载时要使用的协议版本，以便所有主机都使用相同的版本，从而使用相同的锁定模式。请勿在主机之间混用 NFS 版本。如果可能，请使用主机配置文件检查合规性。
+
** 由于 NFSv3 和 NFSv4.1 之间不会自动转换数据存储库，因此请创建一个新的 NFSv4.1 数据存储库，并使用 Storage vMotion 将 VM 迁移到新数据存储库。
** 请参见中的 NFS v4.1 互操作性表注释 https://mysupport.netapp.com/matrix/["NetApp 互操作性表工具"^] 支持所需的特定 ESXi 修补程序级别。


* NFS 导出策略用于控制 vSphere 主机的访问。您可以对多个卷（数据存储库）使用一个策略。对于 NFSv3 ， ESXi 使用 sys （ UNIX ）安全模式，并需要根挂载选项来执行 VM 。在 ONTAP 中，此选项称为超级用户，使用超级用户选项时，无需指定匿名用户 ID 。请注意，对于 ` -anon` 和 ` -allow-suid` ，具有不同值的导出策略规则可能会导致 ONTAP SVM 在使用发生原因工具时出现问题。下面是一个策略示例：
+
** 访问协议： nfs3.
** 客户端匹配规范： 192.168.42.21
** RO 访问规则： sys
** RW 访问规则： sys
** 匿名 UID ：
** 超级用户： sys


* 如果使用适用于 VMware VAAI 的 NetApp NFS 插件，则在创建或修改导出策略规则时，应将协议设置为 `NFS` 。要使 VAAI 副本卸载正常工作，需要使用 NFSv4 协议，将此协议指定为 `NFS` 会自动包括 NFSv3 和 NFSv4 版本。
* NFS 数据存储库卷是从 SVM 的根卷接合的；因此， ESXi 也必须有权访问根卷，才能导航和挂载数据存储库卷。根卷以及嵌套了数据存储库卷接合的任何其他卷的导出策略都必须包含一个或多个规则，这些规则适用于为其授予只读访问权限的 ESXi 服务器。下面是根卷的示例策略，也是使用 VAAI 插件的：
+
** 访问协议。NFS （包括 nfs3 和 nfs4 ）
** 客户端匹配规范192.168.42.21
** RO 访问规则。系统
** RW 访问规则。从不（根卷的最佳安全性）
** 匿名 UID 。
** 超级用户。sys （对于 VAAI 的根卷也是必需的）


* 使用适用于 VMware vSphere 的 ONTAP 工具（最重要的最佳实践）：
+
** 使用适用于 VMware vSphere 的 ONTAP 工具配置数据存储库，因为它可以自动简化导出策略的管理。
** 使用此插件为 VMware 集群创建数据存储库时，请选择集群，而不是单个 ESX 服务器。选择此选项会将数据存储库自动挂载到集群中的所有主机。
** 使用插件挂载功能将现有数据存储库应用于新服务器。
** 如果不对 VMware vSphere 使用 ONTAP 工具，请对所有服务器或需要额外访问控制的每个服务器集群使用一个导出策略。


* 虽然 ONTAP 提供了一个灵活的卷命名空间结构，可以使用接合在树中排列卷，但这种方法对于 vSphere 来说毫无价值。无论存储的命名空间层次结构如何，它都会在数据存储库的根目录下为每个 VM 创建一个目录。因此，最佳实践是，只需将 vSphere 卷的接合路径挂载到 SVM 的根卷，即适用于 VMware vSphere 的 ONTAP 工具如何配置数据存储库。如果没有嵌套的接合路径，也意味着任何卷都不依赖于根卷以外的任何卷，即使有意使某个卷脱机或销毁该卷，也不会影响指向其他卷的路径。
* 对于 NFS 数据存储库上的 NTFS 分区，块大小为 4k 是可以的。下图显示了从 vSphere 主机到 ONTAP NFS 数据存储库的连接。


image:vsphere_ontap_image3.png["错误：缺少图形映像"]

下表列出了 NFS 版本和支持的功能。

|===
| vSphere 功能 | NFSv3 | NFSv4.1 


| VMotion 和 Storage vMotion | 是的。 | 是的。 


| 高可用性 | 是的。 | 是的。 


| 容错 | 是的。 | 是的。 


| DRS | 是的。 | 是的。 


| 主机配置文件 | 是的。 | 是的。 


| 存储 DRS | 是的。 | 否 


| 存储 I/O 控制 | 是的。 | 否 


| SRM | 是的。 | 否 


| 虚拟卷 | 是的。 | 否 


| 硬件加速（ VAAI ） | 是的。 | 是（ vSphere 6.5 及更高版本， NetApp VAAI 插件 1.1.2 ） 


| Kerberos 身份验证 | 否 | 是（在 vSphere 6.5 及更高版本中进行了增强，可支持 AES ， krb5i ） 


| 多路径支持 | 否 | 否（ ESXi 6.5 及更高版本支持通过会话中继； ONTAP 支持通过 pNFS ） 
|===


== 下一步是什么？

完成这些任务后， NFS 数据存储库便可用于配置虚拟机。
