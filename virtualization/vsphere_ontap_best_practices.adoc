---
sidebar: sidebar 
permalink: virtualization/vsphere_ontap_best_practices.html 
keywords: vSphere, datastore, VMFS, FC, FCoE, NVMe/FC, iSCSI, NFS, vVols 
summary: 本页介绍在 VMware vSphere 环境中实施 NetApp ONTAP Storage 解决方案的最佳实践。 
---
= 数据存储库和协议
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/




== vSphere 数据存储库和协议功能

在运行ONTAP 软件的系统上、可以使用七种协议将VMware vSphere连接到数据存储库：

* FCP
* FCoE
* NVMe/FC
* NVMe/TCP
* iSCSI
* NFS v3
* NFS v4.1


FCP、FCoE、NVMe/FC、NVMe/TCP和iSCSI是块协议、它们使用vSphere虚拟机文件系统(VMFS)将VM存储在ONTAP FlexVol 卷中包含的ONTAP LUN或NVMe命名空间中。请注意，从 vSphere 7.0 开始， VMware 不再支持在生产环境中使用软件 FCoE 。NFS 是一种文件协议，无需使用 VMFS 即可将虚拟机放置到数据存储库（即 ONTAP 卷）中。SMB (CIFS)、iSCSI、NVMe/TCP或NFS也可以从子操作系统直接使用到ONTAP。

下表显示了 ONTAP 支持的 vSphere 传统数据存储库功能。此信息不适用于VVOL数据存储库、但它通常适用于使用受支持的ONTAP 版本的适用场景 vSphere 6.x及更高版本。您也可以参考 https://www.vmware.com/support/pubs/["VMware 配置最大值"^] 用于确认特定限制的特定 vSphere 版本。

|===
| 功能 / 功能 | FC/FCoE | iSCSI | NVMe-oF | NFS 


| 格式。 | VMFS 或原始设备映射（ RDM ） | VMFS 或 RDM | VMFS | 不适用 


| 数据存储库或 LUN 的最大数量 | 每个主机1024个LUN | 每个服务器1024个LUN | 每个服务器256个命名空间 | 256 个挂载默认 NFS 。最大卷数为 8 。使用适用于 VMware vSphere 的 ONTAP 工具将其增加到 256 。 


| 最大数据存储库大小 | 64 TB | 64 TB | 64 TB | 使用 FlexGroup 卷时为 100 TB 或更高的 FlexVol 卷 


| 最大数据存储库文件大小 | 62 TB | 62 TB | 62 TB | 使用ONTAP 9.12.1RC1及更高版本并启用大文件时为16 TB或62 TB 


| 每个 LUN 或文件系统的最佳队列深度 | 64 | 64 | 已自动协商 | 请参见中的NFS.MaxQueueDepth https://docs.netapp.com/us-en/netapp-solutions/virtualization/vsphere_ontap_recommended_esxi_host_and_other_ontap_settings.html["建议的 ESXi 主机和其他 ONTAP 设置"^]。 
|===
下表列出了支持的 VMware 存储相关功能。

|===
| 容量 / 功能 | FC/FCoE | iSCSI | NVMe-oF | NFS 


| VMotion | 是的。 | 是的。 | 是的。 | 是的。 


| 存储 vMotion | 是的。 | 是的。 | 是的。 | 是的。 


| VMware HA | 是的。 | 是的。 | 是的。 | 是的。 


| 存储分布式资源计划程序（ Storage Distributed Resource Scheduler ， SDRS ） | 是的。 | 是的。 | 是的。 | 是的。 


| 支持 VMware vStorage APIs for Data Protection （ VADP ）的备份软件 | 是的。 | 是的。 | 是的。 | 是的。 


| 虚拟机中的 Microsoft 集群服务（ MSCS ）或故障转移集群 | 是的。 | 是 * | 是 * | 不支持 


| 容错 | 是的。 | 是的。 | 是的。 | 是的。 


| Site Recovery Manager | 是的。 | 是的。 | 否 | 仅v3 


| 精简配置的 VM （虚拟磁盘） | 是的。 | 是的。 | 是的。 | 是。如果不使用 VAAI ，则此设置是 NFS 上所有 VM 的默认设置。 


| VMware 原生多路径 | 是的。 | 是的。 | 是、使用新的高性能插件(HPP) | 不适用 
|===
下表列出了支持的 ONTAP 存储管理功能。

|===
| 功能 / 功能 | FC/FCoE | iSCSI | NVMe-oF | NFS 


| 重复数据删除 | 阵列中的节省量 | 阵列中的节省量 | 阵列中的节省量 | 数据存储库中的节省量 


| 精简配置 | 数据存储库或 RDM | 数据存储库或 RDM | 数据存储库 | 数据存储库 


| 调整数据存储库大小 | 仅增长 | 仅增长 | 仅增长 | 增长，自动增长和缩减 


| 适用于 Windows 和 Linux 应用程序的 SnapCenter 插件（在子系统中） | 是的。 | 是的。 | 否 | 是的。 


| 使用适用于 VMware vSphere 的 ONTAP 工具监控和主机配置 | 是的。 | 是的。 | 否 | 是的。 


| 使用适用于 VMware vSphere 的 ONTAP 工具进行配置 | 是的。 | 是的。 | 否 | 是的。 
|===
下表列出了支持的备份功能。

|===
| 功能 / 功能 | FC/FCoE | iSCSI | NVMe-oF | NFS 


| ONTAP Snapshot 副本 | 是的。 | 是的。 | 是的。 | 是的。 


| 复制的备份支持 SRM | 是的。 | 是的。 | 否 | 仅v3 


| 卷 SnapMirror | 是的。 | 是的。 | 是的。 | 是的。 


| VMDK 映像访问 | 支持 VADP 的备份软件 | 支持 VADP 的备份软件 | 支持 VADP 的备份软件 | 启用了 VADP 的备份软件， vSphere Client 和 vSphere Web Client 数据存储库浏览器 


| vmdk 文件级访问 | 启用了 VADP 的备份软件，仅限 Windows | 启用了 VADP 的备份软件，仅限 Windows | 启用了 VADP 的备份软件，仅限 Windows | 支持 VADP 的备份软件和第三方应用程序 


| NDMP 粒度 | 数据存储库 | 数据存储库 | 数据存储库 | 数据存储库或 VM 
|===
* NetApp建议对Microsoft集群使用来宾iSCSI、而不是在VMFS数据存储库中使用启用了多写入程序的VMDK。Microsoft 和 VMware 完全支持这种方法，并可通过 ONTAP （ SnapMirror 到内部或云中的 ONTAP 系统）提供极大的灵活性，易于配置和自动化，并可通过 SnapCenter 进行保护。vSphere 7 添加了一个新的集群模式 VMDK 选项。这与启用了多写入程序的VMDK不同、它需要一个通过FC协议提供的数据存储库、该协议已启用集群模式VMDK支持。其他限制适用。请参见 VMware 的 https://docs.vmware.com/en/VMware-vSphere/7.0/vsphere-esxi-vcenter-server-70-setup-wsfc.pdf["Windows Server 故障转移集群设置"^] 配置准则文档。

*使用NVMe-oF和NFS v4.1的数据存储库需要vSphere复制。SRM不支持基于阵列的复制。



== 选择存储协议

运行 ONTAP 软件的系统支持所有主要存储协议，因此客户可以根据现有和计划的网络基础架构以及员工技能选择最适合其环境的存储协议。NetApp 测试通常表明，以相似的线路速度运行的协议之间差别不大，因此，与原始协议性能相比，最好重点关注您的网络基础架构和员工能力。

在考虑选择协议时，以下因素可能会很有用：

* * 当前的客户环境。 * 尽管 IT 团队通常擅长管理以太网 IP 基础架构，但并非所有团队都擅长管理 FC SAN 网络结构。但是，使用非存储流量专用的通用 IP 网络可能无法正常工作。请考虑您已有的网络基础架构，任何计划内的改进，以及管理这些改进的人员的技能和可用性。
* * 易于设置。 * 除了 FC 网络结构的初始配置（额外的交换机以及 HBA 和固件的布线，分区以及互操作性验证）之外，块协议还需要创建和映射 LUN 以及通过子操作系统进行发现和格式化。创建并导出 NFS 卷后，它们将由 ESXi 主机挂载并准备好使用。NFS 没有特殊的硬件资格认定或固件可供管理。
* * 易于管理。 * 使用 SAN 协议时，如果需要更多空间，则需要执行几个步骤，包括增加 LUN ，重新扫描以发现新大小，然后增加文件系统大小。虽然可以增加 LUN 的大小，但不能减小 LUN 的大小，因此恢复未使用的空间可能需要额外的工作。NFS 可以轻松地进行大小调整，存储系统可以自动调整大小。SAN 可通过子操作系统剪切 /UNMAP 命令提供空间回收，从而允许将已删除文件中的空间返回到阵列。使用 NFS 数据存储库时，这种类型的空间回收会更加困难。
* * 存储空间透明度。 * 在 NFS 环境中，存储利用率通常更容易查看，因为精简配置可以立即实现节省。同样，重复数据删除和克隆节省的空间可立即用于同一数据存储库中的其他虚拟机或其他存储系统卷。NFS 数据存储库中的虚拟机密度通常也会更高，这样可以减少要管理的数据存储库数量，从而节省重复数据删除的空间，并降低管理成本。




== 数据存储库布局

ONTAP 存储系统可以非常灵活地为 VM 和虚拟磁盘创建数据存储库。尽管在使用 VSC 为 vSphere 配置数据存储库时会应用许多 ONTAP 最佳实践（在一节中列出） link:vsphere_ontap_recommended_esxi_host_and_other_ontap_settings.html["建议的 ESXi 主机和其他 ONTAP 设置"]），下面是需要考虑的其他一些准则：

* 使用 ONTAP NFS 数据存储库部署 vSphere 可实现高性能，易于管理的实施，从而提供基于块的存储协议无法实现的虚拟机与数据存储库比率。此架构可将数据存储库密度提高十倍，并相应地减少数据存储库数量。虽然较大的数据存储库可以提高存储效率并提供运营优势，但请考虑至少使用四个数据存储库（ FlexVol 卷）将虚拟机存储在一个 ONTAP 控制器上，以便从硬件资源中获得最大性能。通过这种方法，您还可以使用不同的恢复策略建立数据存储库。根据业务需求、某些备份或复制的频率比其他备份或复制的频率要高。FlexGroup 卷不需要多个数据存储库来提高性能、因为它们可以根据设计进行扩展。
* NetApp 建议使用 FlexVol 卷，并且从 ONTAP 9.8 FlexGroup 卷开始，使用 NFS 数据存储库。通常不建议使用其他 ONTAP 存储容器，例如 qtree ，因为适用于 VMware vSphere 的 ONTAP 工具目前不支持这些容器。在一个卷中将数据存储库部署为多个 qtree 对于高度自动化的环境可能很有用，这些环境可以从数据存储库级别的配额或 VM 文件克隆中受益。
* 对于 FlexVol 卷数据存储库，大小合适的数据存储库大约为 4 TB 到 8 TB 。这种大小可以很好地平衡性能，易管理性和数据保护。从小规模入手（例如 4 TB ），然后根据需要扩展数据存储库（最大 100 TB ）。较小的数据存储库可以更快地从备份中或发生灾难后进行恢复，并可在集群中快速移动。请考虑使用 ONTAP 自动调整大小功能在已用空间发生变化时自动增长和缩减卷。默认情况下，适用于 VMware vSphere 数据存储库配置向导的 ONTAP 工具会对新数据存储库使用自动调整大小。可以使用 System Manager 或命令行对增长和缩减阈值以及大小上限和下限进行其他自定义。
* 或者，也可以为 VMFS 数据存储库配置由 FC ， iSCSI 或 FCoE 访问的 LUN 。VMFS 允许集群中的每个 ESX 服务器同时访问传统 LUN 。VMFS 数据存储库的大小最多可达 64 TB ，并且最多可包含 32 个 2 TB LUN （ VMFS 3 ）或一个 64 TB LUN （ VMFS 5 ）。大多数系统上的ONTAP 最大LUN大小为16 TB、而全SAN阵列系统上的最大LUN大小为128 TB。因此，可以使用四个 16 TB LUN 在大多数 ONTAP 系统上创建最大大小的 VMFS 5 数据存储库。尽管具有多个LUN (使用高端FAS 或AFF 系统)的高I/O工作负载可获得性能优势、但创建、管理和保护数据存储库LUN的管理复杂性增加以及可用性风险增加、抵消了这一优势。NetApp 通常建议为每个数据存储库使用一个大型 LUN ，并且只有在特殊需要超过 16 TB 数据存储库时才会跨越。与 NFS 一样，请考虑使用多个数据存储库（卷），以便在一个 ONTAP 控制器上最大限度地提高性能。
* 较旧的子操作系统（ OS ）需要与存储系统对齐，以获得最佳性能和存储效率。但是， Microsoft 和 Linux 分销商（例如 Red Hat ）提供的现代供应商支持的操作系统不再需要进行调整，以便在虚拟环境中将文件系统分区与底层存储系统的块对齐。如果您使用的旧操作系统可能需要对齐，请使用 "VM 对齐 " 在 NetApp 支持知识库中搜索文章，或者向 NetApp 销售人员或合作伙伴联系人请求 TR-3747 的副本。
* 避免在子操作系统中使用碎片整理实用程序，因为这不会提高性能，并会影响存储效率和 Snapshot 副本空间使用量。此外，还应考虑在子操作系统中关闭虚拟桌面的搜索索引。
* ONTAP 凭借创新的存储效率功能引领行业发展，帮助您充分利用可用磁盘空间。AFF 系统通过默认实时重复数据删除和数据压缩进一步提高了这种效率。数据会在聚合中的所有卷之间进行重复数据删除，因此您无需再将相似的操作系统和类似应用程序分组到一个数据存储库中，即可最大程度地节省空间。
* 在某些情况下，您甚至可能不需要数据存储库。为了获得最佳性能和易管理性，请避免对数据库和某些应用程序等高 I/O 应用程序使用数据存储库。而是考虑由子系统拥有的文件系统，例如由子系统管理或使用 RDM 管理的 NFS 或 iSCSI 文件系统。有关具体的应用指南，请参见适用于您的应用程序的 NetApp 技术报告。例如： http://www.netapp.com/us/media/tr-3633.pdf["TR-3633 ： Data ONTAP 上的 Oracle 数据库"^] 包含一个有关虚拟化的章节，其中包含有用的详细信息。
* 一级磁盘（或经过改进的虚拟磁盘）支持独立于运行 vSphere 6.5 及更高版本的 VM 的 vCenter 管理磁盘。虽然它们主要由 API 管理，但对于 VVOL 很有用，尤其是在由 OpenStack 或 Kubernetes 工具管理时。ONTAP 以及适用于 VMware vSphere 的 ONTAP 工具均支持这些功能。




== 数据存储库和 VM 迁移

将 VM 从另一个存储系统上的现有数据存储库迁移到 ONTAP 时，请记住以下一些实践：

* 使用 Storage vMotion 将虚拟机的批量移动到 ONTAP 。这种方法不仅不会对正在运行的 VM 造成中断，而且还可以通过实时重复数据删除和数据压缩等 ONTAP 存储效率功能在数据迁移时对其进行处理。请考虑使用 vCenter 功能从清单列表中选择多个 VM ，然后在适当的时间计划迁移（单击操作时使用 Ctrl 键）。
* 虽然您可以仔细规划迁移到适当的目标数据存储库，但批量迁移之后再根据需要进行组织往往会更简单。如果您有特定的数据保护需求，例如不同的 Snapshot 计划，则可能需要使用此方法来指导您迁移到不同的数据存储库。
* 大多数 VM 及其存储可以在运行时进行迁移（热迁移），但从另一个存储系统迁移连接的存储（不在数据存储库中），例如 ISO ， LUN 或 NFS 卷可能需要冷迁移。
* 需要更仔细迁移的虚拟机包括使用连接存储的数据库和应用程序。通常，请考虑使用应用程序的工具来管理迁移。对于 Oracle ，请考虑使用 RMAN 或 ASM 等 Oracle 工具迁移数据库文件。请参见 https://www.netapp.com/us/media/tr-4534.pdf["TR-4534"^] 有关详细信息 ...同样，对于 SQL Server ，请考虑使用 SQL Server Management Studio 或 NetApp 工具，例如适用于 SQL Server 的 SnapManager 或 SnapCenter 。




== 适用于 VMware vSphere 的 ONTAP 工具

将 vSphere 与运行 ONTAP 软件的系统结合使用时，最重要的最佳实践是安装和使用适用于 VMware vSphere 的 ONTAP 工具插件（以前称为虚拟存储控制台）。无论使用 SAN 还是 NAS ，此 vCenter 插件均可简化存储管理，提高可用性并降低存储成本和运营开销。它使用最佳实践来配置数据存储库，并针对多路径和 HBA 超时优化 ESXi 主机设置（这些内容在附录 B 中进行了介绍）。由于它是一个 vCenter 插件，因此可供连接到 vCenter 服务器的所有 vSphere Web 客户端使用。

此插件还可帮助您在 vSphere 环境中使用其他 ONTAP 工具。它允许您安装适用于 VMware VAAI 的 NFS 插件，该插件支持将副本卸载到 ONTAP 以执行 VM 克隆操作，为厚虚拟磁盘文件预留空间以及执行 ONTAP Snapshot 副本卸载。

该插件也是适用于 ONTAP 的 VASA Provider 的许多功能的管理界面，支持使用 VVOL 进行基于存储策略的管理。注册适用于 VMware vSphere 的 ONTAP 工具后，可使用它创建存储功能配置文件，将其映射到存储，并确保数据存储库随时间的推移符合这些配置文件。VASA Provider 还提供了一个用于创建和管理 VVol 数据存储库的界面。

一般来说， NetApp 建议在 vCenter 中使用适用于 VMware vSphere 的 ONTAP 工具来配置传统数据存储库和 VVOL 数据存储库，以确保遵循最佳实践。



== 常规网络连接

在将 vSphere 与运行 ONTAP 软件的系统结合使用时，配置网络设置非常简单，与其他网络配置类似。需要考虑以下几点：

* 将存储网络流量与其他网络分开。可以通过使用专用 VLAN 或单独的存储交换机来实现单独的网络。如果存储网络共享上行链路等物理路径，您可能需要 QoS 或其他上行链路端口来确保带宽充足。不要将主机直接连接到存储；使用交换机具有冗余路径，并允许 VMware HA 在不干预的情况下运行。
* 如果您的网络需要并支持巨型帧，则可以使用巨型帧，尤其是在使用 iSCSI 时。如果使用这些协议，请确保在存储和 ESXi 主机之间的路径中的所有网络设备， VLAN 等上对其进行相同的配置。否则，您可能会看到性能或连接问题。此外，还必须在 ESXi 虚拟交换机， VMkernel 端口以及每个 ONTAP 节点的物理端口或接口组上以相同的方式设置 MTU 。
* NetApp 仅建议在 ONTAP 集群中的集群网络端口上禁用网络流量控制。对于用于数据流量的其余网络端口， NetApp 不提供其他最佳实践建议。您应根据需要启用或禁用。请参见 http://www.netapp.com/us/media/tr-4182.pdf["TR-4182"^] 了解有关流量控制的更多背景信息。
* 当 ESXi 和 ONTAP 存储阵列连接到以太网存储网络时， NetApp 建议将这些系统连接到的以太网端口配置为快速生成树协议（ RSTP ）边缘端口或使用 Cisco PortFast 功能。NetApp 建议在使用 Cisco PortFast 功能且为 ESXi 服务器或 ONTAP 存储阵列启用了 802.1Q VLAN 中继的环境中启用生成树 PortFast 中继功能。
* NetApp 建议采用以下链路聚合最佳实践：
+
** 使用多机箱链路聚合组方法(例如Cisco的虚拟端口通道(Virtual PortChannel、vPC))在两个独立交换机机箱上支持端口链路聚合的交换机。
** 对连接到ESXi的交换机端口禁用LACP、除非您使用的是配置了LACP的dvSwitches 5.1或更高版本。
** 使用LACP为具有IP哈希的动态多模式接口组的ONTAP 存储系统创建链路聚合。
** 在ESXi上使用IP哈希绑定策略。




下表汇总了网络配置项，并指出了这些设置的应用位置。

|===
| 项目 | ESXi | 交换机 | Node | SVM 


| IP 地址 | VMkernel | 否 | 否 | 是的。 


| 链路聚合 | 虚拟交换机 | 是的。 | 是的。 | 否 * 


| VLAN | VMkernel 和 VM 端口组 | 是的。 | 是的。 | 否 * 


| 流量控制 | NIC | 是的。 | 是的。 | 否 * 


| 生成树 | 否 | 是的。 | 否 | 否 


| MTU （适用于巨型帧） | 虚拟交换机和 VMkernel 端口（ 9000 ） | 是（设置为最大值） | 是（ 9000 ） | 否 * 


| 故障转移组 | 否 | 否 | 是（创建） | 是（选择） 
|===
* SVM LIF连接到具有VLAN、MTU和其他设置的端口、接口组或VLAN接口。但是、这些设置不会在SVM级别进行管理。

这些设备具有自己的 IP 地址进行管理，但这些地址不会在 ESXi 存储网络环境中使用。



== SAN （ FC ， FCoE ， NVMe/FC ， iSCSI ）， RDM

在 vSphere 中，可以通过三种方式使用块存储 LUN ：

* 使用 VMFS 数据存储库
* 使用原始设备映射（ RDM ）
* 作为 LUN ，由软件启动程序从 VM 子操作系统访问和控制


VMFS 是一种高性能集群文件系统，可提供共享存储池中的数据存储库。可以为 VMFS 数据存储库配置 LUN ，这些 LUN 可通过 NVMe/FC 协议访问的 FC ， iSCSI ， FCoE 或 NVMe 命名空间进行访问。VMFS 允许集群中的每个 ESX 服务器同时访问传统 LUN 。ONTAP 最大 LUN 大小通常为 16 TB ；因此，使用四个 16 TB LUN （所有 SAN 阵列系统均支持最大 VMFS LUN 大小为 64 TB ）来创建最大 64 TB 的 VMFS 5 数据存储库（请参见本节中的第一个表）。由于 ONTAP LUN 架构不具有较小的单个队列深度，因此 ONTAP 中的 VMFS 数据存储库可以以相对简单的方式扩展到比传统阵列架构更大的程度。

vSphere 内置了对存储设备的多条路径的支持，称为原生多路径（ NMP ）。NMP 可以检测受支持存储系统的存储类型，并自动配置 NMP 堆栈以支持正在使用的存储系统的功能。

NMP 和 NetApp ONTAP 均支持非对称逻辑单元访问（ Asymmetric Logical Unit Access ， ALUA ）来协商优化和非优化路径。在 ONTAP 中，经过 ALUA 优化的路径遵循直接数据路径，并使用托管所访问 LUN 的节点上的目标端口。默认情况下，在 vSphere 和 ONTAP 中均已启用 ALUA 。NMP 会将 ONTAP 集群识别为 ALUA ，并使用 ALUA 存储阵列类型插件（`VMW_SATAP_ALUA` ），然后选择轮循路径选择插件（`VMW_PSP_RR` ）。

ESXi 6 最多支持 256 个 LUN 以及 1 ， 024 个 LUN 的总路径。ESXi 无法识别超出这些限制的任何 LUN 或路径。假设 LUN 数量达到最大值，则路径限制允许每个 LUN 使用四个路径。在较大的 ONTAP 集群中，可以在达到 LUN 限制之前达到路径限制。为了解决此限制， ONTAP 在 8.3 及更高版本中支持选择性 LUN 映射（ SLM ）。

SLM 会限制向给定 LUN 公布路径的节点。NetApp 最佳实践是，每个 SVM 的每个节点至少具有一个 LIF ，并使用 SLM 限制向托管 LUN 的节点及其 HA 配对节点公布的路径。尽管存在其他路径，但默认情况下不会公布这些路径。可以使用 SLM 中的添加和删除报告节点参数修改公布的路径。请注意，在 8.3 之前的版本中创建的 LUN 会公布所有路径，需要进行修改，以便仅向托管 HA 对公布这些路径。有关 SLM 的详细信息，请查看的第 5.9 节 http://www.netapp.com/us/media/tr-4080.pdf["TR-4080"^]。也可以使用先前的端口集方法进一步减少 LUN 的可用路径。端口集有助于减少 igroup 中启动程序可通过的可见路径数。

* 默认情况下， SLM 处于启用状态。除非使用端口集，否则不需要进行其他配置。
* 对于在 Data ONTAP 8.3 之前创建的 LUN ，请手动应用 SLM ，方法是运行 `lun mapping remove-reporting-nodes` 命令删除 LUN 报告节点并将 LUN 访问限制为 LUN 所属节点及其 HA 配对节点。


块协议（ iSCSI ， FC 和 FCoE ）使用 LUN ID 和序列号以及唯一名称来访问 LUN 。FC 和 FCoE 使用全球通用名称（ WWPN 和 WWPN ）， iSCSI 使用 iSCSI 限定名称（ IQN ）。存储中 LUN 的路径对于块协议没有意义，并且不会显示在协议的任何位置。因此，只包含 LUN 的卷根本无需在内部挂载，而包含数据存储库中使用的 LUN 的卷则不需要接合路径。ONTAP 中的 NVMe 子系统的工作原理类似。

要考虑的其他最佳实践：

* 确保为 ONTAP 集群中每个节点上的每个 SVM 创建一个逻辑接口（ LIF ），以最大程度地提高可用性和移动性。ONTAP SAN 最佳实践是，每个节点使用两个物理端口和 LIF ，每个网络结构使用一个。ALUA 用于解析路径并识别活动优化（直接）路径与活动非优化路径。ALUA 用于 FC ， FCoE 和 iSCSI 。
* 对于 iSCSI 网络，如果存在多个虚拟交换机，请在采用 NIC 绑定的不同网络子网上使用多个 VMkernel 网络接口。您还可以使用连接到多个物理交换机的多个物理 NIC 来提供 HA 并提高吞吐量。下图提供了多路径连接的示例。在 ONTAP 中，使用连接到两个或更多交换机的两个或更多链路配置一个单模式接口组以进行故障转移，或者使用 LACP 或其他具有多模式接口组的链路聚合技术来提供 HA 和链路聚合的优势。
* 如果在 ESXi 中使用质询握手身份验证协议（ Challenge-Handshake Authentication Protocol ， CHAP ）进行目标身份验证，则还必须使用命令行界面（`vserver iscsi security create` ）或 System Manager （在 "Storage">"SVM">"SVM 设置 ">" 协议 ">"iSCSI" 下编辑 "Initiator Security" ）在 ONTAP 中进行配置。
* 使用适用于 VMware vSphere 的 ONTAP 工具创建和管理 LUN 和 igroup 。此插件会自动确定服务器的 WWPN 并创建适当的 igroup 。它还会根据最佳实践配置 LUN 并将其映射到正确的 igroup 。
* 请小心使用 RDM ，因为它们可能更难管理，并且它们也使用路径，这些路径会受到前面所述的限制。ONTAP LUN 支持这两者 https://kb.vmware.com/s/article/2009226["物理和虚拟兼容模式"^] RDM 。
* 有关将 NVMe/FC 与 vSphere 7.0 结合使用的详细信息，请参见此部分 https://docs.netapp.com/us-en/ontap-sanhost/nvme_esxi_7.html["《 ONTAP NVMe/FC 主机配置指南》"^] 和 http://www.netapp.com/us/media/tr-4684.pdf["TR-4684"^]下图显示了从 vSphere 主机到 ONTAP LUN 的多路径连接。


image:vsphere_ontap_image2.png["错误：缺少图形映像"]



== NFS

通过 vSphere ，客户可以使用企业级 NFS 阵列为 ESXi 集群中的所有节点提供对数据存储库的并发访问。如数据存储库一节所述，在将 NFS 与 vSphere 结合使用时，可以获得一些易用性和存储效率可见性优势。

将 ONTAP NFS 与 vSphere 结合使用时，建议采用以下最佳实践：

* 为 ONTAP 集群中每个节点上的每个 SVM 使用一个逻辑接口（ LIF ）。不再需要以往为每个数据存储库建议的 LIF 。虽然直接访问（ LIF 和同一节点上的数据存储库）是最佳选择，但不要担心间接访问，因为通常对性能的影响极小（微秒）。
* 自 VMware Infrastructure 3 以来， VMware 一直支持 NFSv3 。vSphere 6.0 增加了对 NFSv4.1 的支持，该支持可实现 Kerberos 安全性等一些高级功能。如果 NFSv3 使用客户端锁定，则 NFSv4.1 使用服务器端锁定。虽然 ONTAP 卷可以通过这两种协议导出，但 ESXi 只能通过一种协议挂载。此单协议挂载并不会阻止其他 ESXi 主机通过不同版本挂载同一数据存储库。请务必指定挂载时要使用的协议版本，以便所有主机都使用相同的版本，从而使用相同的锁定模式。请勿在主机之间混用 NFS 版本。如果可能，请使用主机配置文件检查合规性。
+
** 由于 NFSv3 和 NFSv4.1 之间不会自动转换数据存储库，因此请创建一个新的 NFSv4.1 数据存储库，并使用 Storage vMotion 将 VM 迁移到新数据存储库。
** 请参见中的 NFS v4.1 互操作性表注释 https://mysupport.netapp.com/matrix/["NetApp 互操作性表工具"^] 支持所需的特定 ESXi 修补程序级别。


* NFS 导出策略用于控制 vSphere 主机的访问。您可以对多个卷（数据存储库）使用一个策略。对于 NFSv3 ， ESXi 使用 sys （ UNIX ）安全模式，并需要根挂载选项来执行 VM 。在 ONTAP 中，此选项称为超级用户，使用超级用户选项时，无需指定匿名用户 ID 。请注意、的导出策略规则具有不同的值 `-anon` 和 `-allow-suid` ONTAP 工具是否存在发生原因 SVM发现问题。下面是一个策略示例：
+
** 访问协议： nfs3.
** 客户端匹配规范： 192.168.42.21
** RO 访问规则： sys
** RW 访问规则： sys
** 匿名UID
** 超级用户： sys


* 如果使用适用于 VMware VAAI 的 NetApp NFS 插件，则在创建或修改导出策略规则时，应将协议设置为 `NFS` 。要使 VAAI 副本卸载正常工作，需要使用 NFSv4 协议，将此协议指定为 `NFS` 会自动包括 NFSv3 和 NFSv4 版本。
* NFS 数据存储库卷是从 SVM 的根卷接合的；因此， ESXi 也必须有权访问根卷，才能导航和挂载数据存储库卷。根卷以及嵌套了数据存储库卷接合的任何其他卷的导出策略都必须包含一个或多个规则，这些规则适用于为其授予只读访问权限的 ESXi 服务器。下面是根卷的示例策略，也是使用 VAAI 插件的：
+
** 访问协议：NFS (包括nfs3和nfs4)
** 客户端匹配规范： 192.168.42.21
** RO 访问规则： sys
** RW访问规则：从不(根卷的最佳安全性)
** 匿名UID
** 超级用户：sys (使用VAAI的根卷也需要此功能)


* 使用适用于 VMware vSphere 的 ONTAP 工具（最重要的最佳实践）：
+
** 使用适用于 VMware vSphere 的 ONTAP 工具配置数据存储库，因为它可以自动简化导出策略的管理。
** 使用此插件为VMware集群创建数据存储库时、请选择集群、而不是单个ESX服务器。选择此选项会将数据存储库自动挂载到集群中的所有主机。
** 使用插件挂载功能将现有数据存储库应用于新服务器。
** 如果不对 VMware vSphere 使用 ONTAP 工具，请对所有服务器或需要额外访问控制的每个服务器集群使用一个导出策略。


* 虽然 ONTAP 提供了一个灵活的卷命名空间结构，可以使用接合在树中排列卷，但这种方法对于 vSphere 来说毫无价值。无论存储的命名空间层次结构如何，它都会在数据存储库的根目录下为每个 VM 创建一个目录。因此，最佳实践是，只需将 vSphere 卷的接合路径挂载到 SVM 的根卷，即适用于 VMware vSphere 的 ONTAP 工具如何配置数据存储库。如果没有嵌套的接合路径，也意味着任何卷都不依赖于根卷以外的任何卷，即使有意使某个卷脱机或销毁该卷，也不会影响指向其他卷的路径。
* 对于 NFS 数据存储库上的 NTFS 分区，块大小为 4k 是可以的。下图显示了从 vSphere 主机到 ONTAP NFS 数据存储库的连接。


image:vsphere_ontap_image3.png["错误：缺少图形映像"]

下表列出了 NFS 版本和支持的功能。

|===
| vSphere 功能 | NFSv3 | NFSv4.1 


| VMotion 和 Storage vMotion | 是的。 | 是的。 


| 高可用性 | 是的。 | 是的。 


| 容错 | 是的。 | 是的。 


| DRS | 是的。 | 是的。 


| 主机配置文件 | 是的。 | 是的。 


| 存储 DRS | 是的。 | 否 


| 存储 I/O 控制 | 是的。 | 否 


| SRM | 是的。 | 否 


| 虚拟卷 | 是的。 | 否 


| 硬件加速（ VAAI ） | 是的。 | 是的。 


| Kerberos 身份验证 | 否 | 是（在 vSphere 6.5 及更高版本中进行了增强，可支持 AES ， krb5i ） 


| 多路径支持 | 否 | 否 
|===


== FlexGroup

ONTAP 9.8 增加了对 vSphere 中 FlexGroup 数据存储库的支持，并增加了适用于 VMware vSphere 9.8 版本的 ONTAP 工具。FlexGroup 简化了大型数据存储库的创建，并自动创建了大量成分卷，以便从 ONTAP 系统中获得最大性能。将 FlexGroup 与 vSphere 结合使用，可用于一个具有完整 ONTAP 集群功能的可扩展 vSphere 数据存储库。

除了对 vSphere 工作负载进行大量系统测试之外， ONTAP 9.8 还为 FlexGroup 数据存储库添加了一种新的副本卸载机制。这样可以使用经过改进的复制引擎在后台的成分卷之间复制文件，同时允许在源和目标上进行访问。如果需要，多个副本会根据规模在成分卷中使用可立即使用且节省空间的文件克隆。

ONTAP 9.8 还为 FlexGroup 文件添加了基于文件的新性能指标（ IOPS ，吞吐量和延迟），这些指标可在适用于 VMware vSphere 的 ONTAP 工具信息板和 VM 报告中查看。适用于 VMware vSphere 的 ONTAP 工具插件还允许您结合使用最大和 / 或最小 IOPS 来设置服务质量（ QoS ）规则。可以在数据存储库中的所有 VM 之间设置这些值，也可以为特定 VM 单独设置这些值。

以下是 NetApp 开发的其他一些最佳实践：

* 使用 FlexGroup 配置默认值。虽然建议使用适用于 VMware vSphere 的 ONTAP 工具，因为它可以在 vSphere 中创建和挂载 FlexGroup ，但也可以使用 ONTAP System Manager 或命令行来满足特殊需求。即使如此，也可以使用默认值，例如每个节点的成分卷成员数，因为这是已通过 vSphere 测试的结果。
* 在估算 FlexGroup 数据存储库的规模时，请记住， FlexGroup 由多个较小的 FlexVol 卷组成，这些卷会创建一个较大的命名空间。因此，请将数据存储库的大小至少设置为最大虚拟机的 8 倍。例如，如果您的环境中有一个 6 TB 的 VM ，请将 FlexGroup 数据存储库的大小调整为不小于 48 TB 。
* 允许 FlexGroup 管理数据存储库空间。已使用 vSphere 数据存储库测试自动调整大小和弹性调整。如果数据存储库容量接近全满，请使用适用于 VMware vSphere 的 ONTAP 工具或其他工具调整 FlexGroup 卷的大小。FlexGroup 可在成分卷之间保持容量和索引节点的平衡，并在容量允许的情况下优先将文件夹（ VM ）中的文件分配给同一成分卷。
* VMware 和 NetApp 目前不支持通用的多路径网络连接方法。对于 NFSv4.1 ， NetApp 支持 pNFS ，而 VMware 支持会话中继。NFSv3 不支持通过多个物理路径访问一个卷。对于采用 ONTAP 9.8 的 FlexGroup ，我们建议的最佳实践是让适用于 VMware vSphere 的 ONTAP 工具进行一次挂载，因为间接访问的影响通常很小（微秒）。可以使用轮循 DNS 在 FlexGroup 中不同节点上的 LIF 之间分布 ESXi 主机，但这需要在不使用适用于 VMware vSphere 的 ONTAP 工具的情况下创建和挂载 FlexGroup 。然后，性能管理功能将不可用。
* 在 9.8 版中，最多已对 1500 个 VM 的 FlexGroup vSphere 数据存储库支持进行了测试。
* 使用适用于 VMware VAAI 的 NFS 插件执行副本卸载。请注意，在 FlexGroup 数据存储库中增强了克隆功能，但在 FlexVol 和 / 或 FlexGroup 卷之间复制虚拟机时，与 ESXi 主机副本相比， ONTAP 不会提供显著的性能优势。
* 使用适用于 VMware vSphere 9.8 的 ONTAP 工具使用 ONTAP 指标（信息板和 VM 报告）监控 FlexGroup VM 的性能，并管理各个 VM 上的 QoS 。目前无法通过 ONTAP 命令或 API 获得这些指标。
* 此时，可以在数据存储库中的各个 VM 或所有 VM 上设置 QoS （最大 / 最小 IOPS ）。在所有 VM 上设置 QoS 将取代任何单独的每 VM 设置。将来，设置不会扩展到新的或迁移的虚拟机；可以在新虚拟机上设置 QoS ，也可以将 QoS 重新应用于数据存储库中的所有虚拟机。
* 适用于 VMware vSphere 的 SnapCenter 插件 4.4 版支持在主存储系统上的 FlexGroup 数据存储库中备份和恢复 VM 。虽然可以手动使用 SnapMirror 将 FlexGroup 复制到二级系统，但 4 号选择控制器不管理二级副本。

