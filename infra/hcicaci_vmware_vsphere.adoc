---
sidebar: sidebar 
permalink: infra/hcicaci_vmware_vsphere.html 
keywords: VMware vSphere, virtualization, workflow, ESXi, vCenter 
summary: TR-4857 
---
= VMware vSphere ：采用 Cisco ACI 的 NetApp HCI
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
VMware vSphere 是行业领先的虚拟化平台，可通过它构建一个具有故障恢复能力的可靠虚拟基础架构。vSphere 包含虚拟化，管理和接口层。VMware vSphere 的两个核心组件是 ESXi 服务器和 vCenter Server 。VMware ESXi 是安装在物理机上的虚拟机管理程序软件，可用于托管 VM 和虚拟设备。vCenter Server 是一项服务，用于管理连接到网络和池主机资源的多个 ESXi 主机。有关 VMware vSphere 的详细信息，请参见相关文档 https://docs.vmware.com/en/VMware-vSphere/index.html["此处"^]。



== 工作流

以下工作流用于启动虚拟环境。其中每个步骤可能涉及多个单独的任务。

. 在 UCS C 系列服务器上以 ACI 模式安装和配置 Nexus 9000 交换机以及 APIC 软件。请参见安装和升级 https://www.cisco.com/c/en/us/support/cloud-systems-management/application-policy-infrastructure-controller-apic/tsd-products-support-series-home.html["文档。"^] 了解详细步骤。
. 请参阅配置和设置 ACI 网络结构 https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/3-x/getting_started/b_APIC_Getting_Started_Guide_Rel_3_x.html["文档。"^]。
. 配置 NetApp HCI 节点所需的租户，应用程序配置文件，网桥域和 EPG 。NetApp 建议使用一个 BD 对一个 EPG 框架，但 iSCSI 除外。请参见文档 https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/2-x/L2_config/b_Cisco_APIC_Layer_2_Configuration_Guide.html["此处"^] 有关详细信息：所需的最小 EPG 集包括带内管理， iSCSI ， iSCSI-A ， iSCSI-B ， VM 移动， VM 数据网络和原生。
+

NOTE: iSCSI 多路径需要两个 iSCSI EPG ： iSCSI-A 和 iSCSI-B ，每个 EPG 都有一个活动上行链路。

+

NOTE: NetApp mNode 要求 iSCSI EPG 同时启用两个上行链路。

. 根据要求创建 VLAN 池，物理域和 AEP 。为各个端口创建交换机和接口配置文件。然后连接物理域并配置指向 EPG 的静态路径。请参见 https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/2-x/L2_config/b_Cisco_APIC_Layer_2_Configuration_Guide.html["配置指南"^] 有关详细信息：
+
image:hcicaci_image6.png["错误：缺少图形映像"]

+
image:hcicaci_image7.png["错误：缺少图形映像"]

+

NOTE: 对于连接到 NetApp HCI 计算节点的接口，使用访问端口策略组；对于连接到 NetApp HCI 存储节点的接口，使用 vPC 策略组。

. 创建和分配合同，以便在工作负载之间进行严格控制的访问。有关配置合同的详细信息，请参见指南 https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/1-x/Operating_ACI/guide/b_Cisco_Operating_ACI/b_Cisco_Operating_ACI_chapter_01000.html["此处"^]。
. 使用 NDE 安装和配置 NetApp HCI 。NDE 会配置所有必需的参数，包括用于网络连接的 VDS 端口组，同时还会安装 mNode VM 。请参见 https://docs.netapp.com/hci/index.jsp["部署指南"^] 有关详细信息 ...
. 虽然 Cisco ACI 与 VMware VDS 的 VMM 集成是可选的，但使用 VMM 集成功能是最佳实践。如果不使用 VMM 集成，则可以使用 NDE 安装的 VDS 通过 Cisco ACI 上的物理域连接进行网络连接。
. 如果您使用的是 VMM 集成，则安装了 NDE 的 VDS 无法由 ACI 完全管理，并且可以添加为只读 VMM 域。为了避免这种情况并高效利用 Cisco ACI 的 VMM 网络功能，请使用新的 VMware vSphere 分布式交换机（ VDS ）和显式动态 VLAN 池在 ACI 中创建一个新的 VMware VMM 域。创建的 VMM 域可以与任何受支持的虚拟交换机集成。
+
.. * 与 VDS 集成。 * 如果要将 ACI 与 VDS 集成，请将虚拟交换机类型选择为 VMware 分布式交换机。请考虑下表中记录的配置最佳实践。请参见 https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/3-x/virtualization/Cisco-ACI-Virtualization-Guide-3-2-x/Cisco-ACI-Virtualization-Guide-3-2-x_chapter_011.html["配置指南"^] 有关详细信息：
+
image:hcicaci_image8.png["错误：缺少图形映像"]

.. * 与 Cisco Ave.* 如果要将 Cisco Ave 与 Cisco ACI 集成，请将虚拟交换机类型选择为 Cisco Ave 。Cisco Ave 需要一个类型为 Internal 的唯一 VLAN 池，以便在内部和外部端口组之间进行通信。请遵循此表中记录的配置最佳实践。请参见 https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/aci_virtual_edge/installation_upgrade/2-x/Cisco-ACI-Virtual-Edge-Installation-Guide-201.html["安装指南"^] 安装和配置 Cisco Ave.
+
image:hcicaci_image9.png["错误：缺少图形映像"]

+
image:hcicaci_image10.png["错误：缺少图形映像"]



. 使用预配置解析即时性将 VMM 域附加到 EPG 。然后，将所有 vmnic ， VMkernel 端口和 VNIC 从 NDE 创建的 VDS 迁移到 ACI 创建的 VDS 或 Ave 等。为 iSCSI-A 和 iSCSI-B 配置上行链路故障转移和绑定策略，使每个上行链路都有一个活动上行链路。现在， VM 可以将其 vmnic 连接到 ACI 创建的端口组以访问网络资源。由 Cisco ACI 管理的 VDS 上的端口组的格式为 ` <tenant-name>><application-profile-name>><EPG-name>` 。
+

NOTE: 要确保在 VMM 控制器连接到虚拟交换机之前将端口策略下载到叶交换机，需要使用预配置解析即时性。

+
image:hcicaci_image11.png["错误：缺少图形映像"]

+
image:hcicaci_image12.png["错误：缺少图形映像"]

. 如果要使用微分段，请创建附加到右侧 BD 的微分段（ uSeg ） EPG 。在 VMware vSphere 中创建属性并将其附加到所需的虚拟机。确保 VMM 域已启用 " 启用标记收集 " 。使用相应属性配置 uSeg EPG ，并将 VMM 域附加到该域。这样可以更精细地控制端点 VM 上的通信。
+
image:hcicaci_image13.png["错误：缺少图形映像"]

+
此解决方案中基于 NetApp HCI 的 VMware vSphere 的网络功能可通过 VMware VDS 或 Cisco Ave 提供。





=== VMware VDS

VMware vSphere 分布式交换机（ VDS ）是一种连接到集群或一组集群中多个 ESXi 主机的虚拟交换机，允许虚拟机在多个主机之间迁移时保持一致的网络配置。VDS 还可集中管理 vSphere 环境中的网络配置。有关详细信息，请参见 https://www.vmware.com/in/products/vsphere/distributed-switch.html["VDS 文档"^]。

image:hcicaci_image14.png["错误：缺少图形映像"]

下表概括了配置 Cisco ACI 并将其与 VMware VDS 集成所需的参数和最佳实践。

|===
| 资源 | 配置注意事项 | 最佳实践 


| 端点组  a| 
* 原生 VLAN 使用单独的 EPG
* 在原生 VLAN EPG 中，将接口静态绑定到 HCI 存储和计算节点使用 802.1p 模式。要使节点发现运行 NDE ，必须执行此操作。
* 使用一个通用的 BD 为 iSCSI ， iSCSI-A 和 iSCSI-B 分离 EPG
* iSCSI-A 和 iSCSI-B 用于 iSCSI 多路径，并用于 ESXi 主机上的 VMkernel 端口
* 运行 NDE 之前要附加到 iSCSI EPG 的物理域
* 要连接到 iSCSI ， iSCSI-A 和 iSCSI-B EPG 的 VMM 域

 a| 
* EPG 之间的合同需要明确定义。仅允许所需端口进行通信。
* 使用唯一的原生 VLAN 进行 NDE 节点发现
* 对于与连接到 VMkernel 端口的端口组对应的 EPG ，要附加 VMM 域并进行预配置以立即解决问题




| 接口策略  a| 
* 所有 ESXi 主机的通用叶访问端口策略组
* 每个 NetApp HCI 存储节点一个 vPC 策略组
* 已启用 LLDP ， CDP 已禁用

 a| 
* 在启用动态分配的情况下，为 VMM 域单独配置 VLAN 池
* 建议对指向 NetApp HCI 存储节点的接口使用具有 LACP 活动端口通道策略的 vPC
* 建议对计算节点使用单个接口，而不使用 LACP 。




| VMM 集成  a| 
* 本地切换首选项
* 访问模式为读写。

 a| 
* 适用于 vSwitch 策略的 mac-Ping-physical-nic-Load
* 发现策略的 LLDP
* 如果使用微分段，则启用标记收集




| VDS  a| 
* iSCSI 端口组的两个上行链路均处于活动状态
* iSCSI A 和 iSCSI B 各一个上行链路

 a| 
* 将所有端口组的负载平衡方法设置为 ‘根据物理 NIC 负载路由 '
* iSCSI VMkernel 端口迁移一次执行一次，从 NDE 部署的 VDS 迁移到 ACI 集成的 VDS




| 轻松扩展  a| 
* 通过为要添加的 ESXi 主机附加相同的叶访问端口策略组来运行 NDE 扩展
* 每个 NetApp HCI 存储节点一个 vPC 策略组
* 要成功扩展 NDE ，应将各个接口（对于 ESXi 主机）和 vPC （对于存储节点）连接到原生，带内管理， iSCSI ， VM Motion EPG
* 已启用 LLDP ， CDP 已禁用

 a| 
* 建议对指向 NetApp HCI 存储节点的接口使用具有 LACP 活动端口通道策略的 vPC
* 建议对计算节点使用单个接口，而不使用 LACP 。


|===

NOTE: 对于流量负载平衡，可在 Cisco ACI 上使用带有 vPC 的端口通道，并在处于活动模式的 LACP 的 VDS 上使用 LAG 。但是，与 iSCSI 多路径相比，使用 LACP 可能会影响存储性能。



=== Cisco AVE

Cisco ACI Virtual Edge （ Ave ）是 Cisco 提供的一款虚拟交换机产品，可将 Cisco ACI 策略模型扩展到虚拟基础架构。它是一种独立于虚拟机管理程序的分布式网络服务，位于虚拟机管理程序的原生虚拟交换机之上。它利用使用基于 VM 的解决方案的底层虚拟交换机，提供对虚拟环境的网络可见性。有关 Cisco Ave 的详细信息，请参见 https://www.cisco.com/c/en/us/products/switches/application-centric-infrastructure-virtual-edge/index.html["文档。"^]。下图显示了 ESXi 主机上 Cisco Ave 的内部网络（已测试）。

image:hcicaci_image15.png["错误：缺少图形映像"]

下表列出了在 VMware ESXi 上配置 Cisco ACI 并将其与 Cisco Ave 集成的必要参数和最佳实践。Cisco Ave 当前仅支持 VMware vSphere 。

|===
| 资源 | 配置注意事项 | 最佳实践 


| 端点组  a| 
* 原生 VLAN 使用单独的 EPG
* 在原生 VLAN EPG 中，将接口静态绑定到 HCI 存储和计算节点使用 802.1p 模式。要使节点发现运行 NDE ，必须执行此操作。
* 使用一个通用的 BD 为 iSCSI ， iSCSI-A 和 iSCSI-B 分离 EPG
* iSCSI-A 和 iSCSI-B 用于 iSCSI 多路径，并用于 ESXi 主机上的 VMkernel 端口
* 运行 NDE 之前要附加到 iSCSI EPG 的物理域
* VMM 域连接到 iSCSI ， iSCSI-A 和 iSCSI-B EPG

 a| 
* 在启用动态分配的情况下，为 VMM 域单独配置 VLAN 池
* EPG 之间的合同需要明确定义。仅允许所需端口进行通信。
* 使用唯一的原生 VLAN 进行 NDE 节点发现
* 对于与要连接到主机 VMkernel 适配器的端口组对应的原生，请在 VMM 域中使用 交换模式
* 对于与传输用户 VM 流量的端口组对应的 EPG ，请在 VMM 域中使用平均交换模式
* 对于与要连接到 VMkernel 端口的端口组对应的 EPG ， VMM 域会附加预配置以立即解决问题




| 接口策略  a| 
* 每个 NetApp HCI 存储节点一个 vPC 策略组
* 已启用 LLDP ， CDP 已禁用
* 运行 NDE 之前，对于 NDE 发现：
+
** 所有 ESXi 主机的叶访问端口策略组


* 运行 NDE 后，对于 Cisco Ave ：
+
** 每个 ESXi 主机一个 vPC 策略组



 a| 
* NetApp 建议对 Cisco Ave 的 ESXi 主机使用 vPC
* 对 vPC 到 ESXi 的端口通道策略使用静态模式
* 对端口通道策略使用第 4 层 SRC 端口负载平衡哈希方法
* NetApp 建议对 NetApp HCI 存储节点的接口使用具有 LACP 活动端口通道策略的 vPC




| VMM 集成  a| 
* 创建一个新的 VLAN 范围（或 Encap Block ），并将角色 Internal and Dynamic Allocation （内部和动态分配）附加到用于 VMM 域的 VLAN 池
* 创建多播地址池（每个 EPG 一个地址）
* 预留与 Ave 光纤范围多播地址所使用的多播地址池不同的另一个多播地址
* 本地切换首选项
* 访问模式为读写模式

 a| 
* 为 vSwitch 策略启用静态模式
* 确保 vSwitch 端口通道策略和接口策略组的端口通道策略使用相同的模式
* 发现策略的 LLDP
* 如果使用微分段，请启用标记收集
* 默认 Encap 模式的建议选项为 VXLAN




| VDS  a| 
* iSCSI 端口组的两个上行链路均处于活动状态
* iSCSI A 和 iSCSI B 各一个上行链路

 a| 
* iSCSI VMkernel 端口从 NDE 部署的 VDS 一次迁移一个到 ACI 集成的 VDS
* 基于 IP 哈希路由所有端口组的负载平衡方法




| Cisco AVE  a| 
* 使用访问端口接口策略组对 ESXi 主机运行 NDE 。要成功运行 NDE ，应将连接到 ESXi 主机的各个接口连接到原生，带内管理， iSCSI ， VM Motion EPG 。
* 环境启动后，将主机置于维护模式，将接口策略组迁移到启用了静态模式的 vPC ，将 vPC 分配给所有必需的 EPG 并将主机从维护模式中删除。对所有主机重复相同的过程。
* 运行 Ave 安装过程以在所有主机上安装 Ave 控制 VM

 a| 
* 使用主机上的本地数据存储库安装 Ave control VM 。每个主机都应安装一个 Ave 控制虚拟机
* 如果 DHCP 在带内管理 VLAN 上不可用，请在该网络上使用网络协议配置文件




| 轻松扩展  a| 
* 对要添加的 ESXi 主机运行 NDE Scale with access port interface policy group 。要成功运行 NDE ，应将各个接口连接到原生，带内管理， iSCSI ， VM Motion EPG 。
* * 将 ESXi 主机添加到 vSphere 集群后，将主机置于维护模式，并将接口策略组迁移到启用了静态模式的 vPC 。然后将 vPC 连接到所需的 EPG 。 *
* 在新主机上运行 Ave 安装过程，以便在该主机上安装 Ave 控制 VM
* 每个 NetApp HCI 存储节点一个 vPC 策略组，以添加到集群中
* 已启用 LLDP ， CDP 已禁用

 a| 
* 使用主机上的本地数据存储库安装 Ave control VM
* 如果 DHCP 在带内管理 VLAN 上不可用，请在该网络上使用网络协议配置文件
* 建议对指向 NetApp HCI 存储节点的接口使用具有 LACP 活动端口通道策略的 vPC


|===

NOTE: 对于流量负载平衡，可在 Cisco ACI 上使用带有 vPC 的端口通道，并在处于活动模式的 LACP 的 ESXi 主机上使用 LAG 。但是，与 iSCSI 多路径相比，使用 LACP 可能会影响存储性能。

link:hcicaci_RHV.html["接下来： Red Hat 虚拟化：采用 Cisco ACI 的 NetApp HCI"]
