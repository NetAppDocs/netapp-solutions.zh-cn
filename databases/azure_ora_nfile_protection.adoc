---
sidebar: sidebar 
permalink: databases/azure_ora_nfile_protection.html 
summary: 本节介绍如何使用azacsnap工具以及快照备份、还原和快照分层到Azure Blob来保护Oracle数据库。 
keywords: Oracle, Azure, database, backup, restore 
---
= 在Azure云中保护Oracle数据库
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:table-stripes: odd
:imagesdir: ./../media/


link:azure_ora_nfile_procedures.html["先前：部署过程。"]

[role="lead"]
作者：NetApp解决方案工程部的Allen Cao



== 使用AzAcSnap工具使用Snapshot备份Oracle数据库

Azure应用程序一致的Snapshot工具(AzAcSnap)是一个命令行工具、可通过处理在创建存储快照之前将第三方数据库置于应用程序一致状态所需的所有流程编排来为其提供数据保护、之后、它会将数据库恢复为运行状态。

对于Oracle、您可以将数据库置于备份模式以创建快照、然后将数据库退出备份模式。



=== 备份数据和日志卷

可以使用执行snapshot命令的简单shell脚本在数据库服务器主机上设置备份。然后、可以计划从crontab运行此脚本。

通常、备份频率取决于所需的RTO和RPO。频繁创建快照会占用更多存储空间。备份频率与空间占用之间存在一定的权衡。

数据卷通常比日志卷占用更多的存储空间。因此、您可以每几小时在数据卷上创建一次快照、而每15到30分钟在日志卷上创建一次更频繁的快照。

请参见以下备份脚本和计划示例。

对于数据卷快照：

[source, cli]
----
 # /bin/sh
cd /home/azacsnap/bin
. ~/.bash_profile
azacsnap -c backup --volume data --prefix acao-ora01-data --retention 36
azacsnap -c backup --volume other --prefix acao-ora01-log --retention 250
----
对于日志卷快照：

[source, cli]
----
 # /bin/sh
cd /home/azacsnap/bin
. ~/.bash_profile
azacsnap -c backup --volume other --prefix acao-ora01-log --retention 250
----
68b7e37ef318c0e56eabf3e1aded4216


NOTE: 设置备份时 `azacsnap.json` 配置文件中、将所有数据卷(包括二进制卷)添加到 `dataVolume` 以及所有日志卷 `otherVolume`。快照的最大保留空间为250个副本。



=== 验证快照

转至Azure门户> Azure NetApp文件/卷以检查是否已成功创建快照。

image:db_ora_azure_anf_snap_01.PNG["此屏幕截图显示了快照列表中的两个文件。"]
image:db_ora_azure_anf_snap_02.PNG["此屏幕截图显示了快照列表中的八个文件。"]



== Oracle从本地备份还原和恢复

Snapshot备份的一个主要优势是、它与源数据库卷共存、并且主数据库卷几乎可以即时回滚。



=== 在主服务器上还原和恢复Oracle

以下示例演示了如何从同一Oracle主机上的Azure信息板和CLI还原和恢复Oracle数据库。

. aa30a622663e0f34541394e008fe82cd
+
ea16560565f3889db4dabf938628b462

+
版权所有（ c ） 1982-2019 ， Oracle 。保留所有权利。

+
已连接到： Oracle Database 19c Enterprise Edition 版本 19.0.0.0.0 - 生产版本 19.8.0.0.0

+
0409b2fce118cc126a532dea158d2943

+
bec6da77877c0793c1d3eb6c6896e98e

+
a5b83945adfd5370663cb2d9c4f31d09

+
6ba18fa8fa7d170dfd8fc80f0f3d39f7

+
d1d2dcb121f8bf8fd39724ea075c6409

+
a92090dde5e820fde0a68705ee3f2bd0

+
fd9736dfc88a182f9cb6e5f6a2b97487

+
 ID
+
[listing]
----
EVENT
--------------------------------------------------------------------------------
DT
---------------------------------------------------------------------------
         1
insert a data marker to validate snapshot restore
12-SEP-22 07.07.35.000000 PM
----
. 将此表放到快照备份之后。
+
07b56c53a9fec8c477afb0cb5f2394af

+
dcd4d50ecf59b4752c161f0ddc44df44

+
版权所有（ c ） 1982-2019 ， Oracle 。保留所有权利。

+
已连接到： Oracle Database 19c Enterprise Edition 版本 19.0.0.0.0 - 生产版本 19.8.0.0.0

+
bee0f13528c2f6f5b67053dc1e942328

+
cd85f26775e453b2177d5fcc6265b31d

+
07e18ec921a195478cdbab47d8d68d89

+
f06f4fbf6e3e0e45b0d4b241ceaf19c9

. 从Azure NetApp Files 信息板中、将日志卷还原到最后一个可用快照。选择*还原卷*。
+
image:db_ora_azure_anf_restore_01.PNG["此屏幕截图显示了ANF信息板中卷的快照还原方法。"]

. 确认还原卷并单击*还原*以完成卷还原到最新可用备份的过程。
+
image:db_ora_azure_anf_restore_02.PNG["出现\"Are you sure you want to do this？\"快照还原页面。"]

. 对数据卷重复相同的步骤、并确保备份包含要恢复的表。
+
image:db_ora_azure_anf_restore_03.PNG["此屏幕截图显示了ANF信息板中数据卷的快照还原方法。"]

. 再次确认卷还原、然后单击"还原"。
+
image:db_ora_azure_anf_restore_04.PNG["出现\"Are you sure you want to do this？\"数据卷快照还原页面。"]

. 如果您有多个控制文件副本、请重新同步这些控制文件、并将旧控制文件替换为可用的最新副本。
+
952cd3804f479f3c31f123d064ccbdf5

. 登录到Oracle服务器VM并使用sqlplus运行数据库恢复。
+
07b56c53a9fec8c477afb0cb5f2394af

+
125ab5cbfb90c4a6d038bcca4da6fdc4

+
版权所有（ c ） 1982-2019 ， Oracle 。保留所有权利。

+
010621501012cd31b6666d17dad683d2

+
6bd3f70e5ab38ca26f8cabd390e15fc0

+
424459a4363a5afdd1e45d31fcd11efe

+
db9afd3f7adaff3fe1135208fa6b6a09

+
abc467423916c8ee7c16f566b4ab4ca8

+
db9afd3f7adaff3fe1135208fa6b6a09

+
479d2dfa77fdcde3bfd41fcdebbca1ff

+
db9afd3f7adaff3fe1135208fa6b6a09

+
c76ff2f7e10a42adf7faec8f9e6faeab

+
0e98028493ec8c4a1d181c0d71c3ec7b

+
f6c9ea366c01da7d664a8c7c3813e0bd

+
fd9736dfc88a182f9cb6e5f6a2b97487

+
 ID
+
[listing]
----
EVENT
--------------------------------------------------------------------------------
DT
---------------------------------------------------------------------------
         1
insert a data marker to validate snapshot restore
12-SEP-22 07.07.35.000000 PM


SQL> select systimestamp from dual;

 SYSTIMESTAMP
---------------------------------------------------------------------------
13-SEP-22 03.28.52.646977 PM +00:00
----


此屏幕显示已删除的表已使用本地快照备份进行恢复。

link:azure_ora_nfile_migration.html["下一步：数据库迁移。"]
