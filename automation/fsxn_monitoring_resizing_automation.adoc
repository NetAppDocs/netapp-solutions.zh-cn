---
sidebar: sidebar 
permalink: automation/fsxn_monitoring_resizing_automation.html 
keywords: AWS, FSX, FSxN, automation, FSxN monitoring, FSxN automation, FSxN resizing, FSx for NetApp ONTAP monitoring, FSx for ONTAP monitoring 
summary: 此页面介绍了有关监控AWS FSxN以及根据阈值自动调整大小的自动化操作。 
---
= 使用AWS Lambda功能进行ONTAP 监控和自动调整大小的FSX
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
作者：Dhruv Tyagi、Niyaz Mohamed



== 概述：通过AWS Lambda功能监控和自动调整适用于ONTAP 的FSX的大小

FSX for ONTAP 是AWS上提供的第一方企业级云存储服务、可提供基于常见NetApp ONTAP 文件系统构建的高度可靠、可扩展、高性能和功能丰富的文件存储。

适用于ONTAP 的FSX可提供无缝的部署和管理体验。无需具备存储专业知识即可开始使用。为了简化监控、可以使用AWS兰达功能(根据阈值自动调整总存储容量、卷大小或LUN大小的大小)。本文档提供了一个分步指南、用于创建一个自动设置、以便定期监控ONTAP 的FSX、在超过用户指定的阈值时发出通知并调整大小、并将调整大小活动通知给管理员。

.功能
[%collapsible]
====
解决方案 提供了以下功能：

* 能够监控：
+
** 适用于ONTAP 的FSX的整体存储容量的使用情况
** 每个卷的使用情况(精简配置/厚配置)
** 每个LUN的使用情况(精简配置/厚配置)


* 能够在违反用户定义的阈值时调整上述任意值的大小
* 通过电子邮件接收使用情况警告和调整大小通知的警报机制
* 可以删除低于用户定义阈值的快照
* 能够获取关联的FlexClone卷和快照列表
* 能够定期监控检查
* 可以使用解决方案 访问互联网、也可以不访问互联网
* 可以手动部署或使用AWS CloudFormation模板进行部署


====
.前提条件
[%collapsible]
====
开始之前、请确保满足以下前提条件：

* 已部署适用于ONTAP 的FSx
* 连接到FSx for ONTAP 的专用子网
* 已为ONTAP 的FSX设置"fsxadmin"密码


====
.高级架构
[%collapsible]
====
* AWS Lambda功能可通过API调用FSX for ONTAP 、以检索和更新存储容量、卷和LUN的大小。
* "fsxadmin"密码作为安全字符串存储在AWS SSM参数存储中、以增加安全层。
* AWS SES (简单电子邮件服务)用于在发生调整大小事件时通知最终用户。
* 如果在无法访问Internet的VPC中部署解决方案 、则会对适用于AWS SSM、FSx和SES的VPC端点进行设置、使Lamb达 能够通过AWS内部网络访问这些服务。


image:fsxn-monitoring-resizing-architecture.png["此图显示了此解决方案 中使用的高级架构。"]

====


== 解决方案 部署



=== 自动化部署

[%collapsible]
====
按照一系列步骤完成此解决方案 的自动部署：

.第1步：克隆GitHub存储库
[%collapsible]
=====
在本地系统上克隆GitHub存储库：

[listing]
----
git clone https://github.com/NetApp-Automation/fsxn-monitoring-auto-resizing.git
----
=====
.第2步：设置AWS S3存储分段
[%collapsible]
=====
. 导航到AWS控制台>*。s3*并单击*创建存储分段*。使用默认设置创建存储分段。
. 进入存储分段后、单击*上传*>*添加文件*、然后从系统上克隆的GitHub存储库中选择*配置式.zip*和*请求式.zip*。
+
image:fsxn-monitoring-resizing-s3-upload-zip-files.png["此图显示了正在上传zip文件的S3窗口"]



=====
.第3步：AWS SES SMTP设置(如果无法访问Internet、则需要此设置)
[%collapsible]
=====
如果您要在不访问Internet的情况下部署解决方案 、请执行此步骤(注意：由于正在设置VPC端点、因此会增加相关成本。)

. 导航到AWS控制台>*AWS Simple Email Service (SES)*> SMTP Settings，然后单击*Create SMTP crederations*
. 输入IAM用户名或将其保留为默认值、然后单击创建。保存用户名和密码以供将来使用。
+

NOTE: 如果SES SMTP设置已到位、请跳过此步骤。

+
image:fsxn-monitoring-resizing-ses-smtp-creds-addition.png["此图显示了AWS SES下的创建SMTP凭据窗口"]



=====
.第4步：AWS CloudFormation部署
[%collapsible]
=====
. 导航到AWS控制台>* CloudFormation*>创建堆栈>使用新资源(标准)。
+
[listing]
----
Prepare template: Template is ready
Specify template: Upload a template file
Choose file: Browse to the cloned GitHub repo and select fsxn-monitoring-solution.yaml
----
+
image:fsxn-monitoring-resizing-create-cft-1.png["此图显示了AWS CloudFormation创建堆栈窗口"]

+
单击下一步

. 输入堆栈详细信息。单击Next、选中I Accloned that AWS CloudFormation m赡 会创建IAM资源复选框、然后单击Submit。
+

NOTE: 如果"VPC是否可访问互联网？" 设置为False、需要提供"AWS SES的SMTP用户名"和"AWS SES的SMTP密码"。否则、可以将其留空。

+
image:fsxn-monitoring-resizing-cft-stack-details-1.png["此图显示了AWS CloudFormation堆栈详细信息窗口"]

+
image:fsxn-monitoring-resizing-cft-stack-details-2.png["此图显示了AWS CloudFormation堆栈详细信息窗口"]

+
image:fsxn-monitoring-resizing-cft-stack-details-3.png["此图显示了AWS CloudFormation堆栈详细信息窗口"]

+
image:fsxn-monitoring-resizing-cft-stack-details-4.png["此图显示了AWS CloudFormation堆栈详细信息窗口"]

. 一旦CloudFormation部署开始、"发件人电子邮件ID"中提及的电子邮件ID将收到一封电子邮件、要求他们授权在AWS SES中使用此电子邮件地址。单击链接以验证电子邮件地址。
. CloudFormation堆栈部署完成后、如果出现任何警告/通知、系统将向收件人电子邮件ID发送一封电子邮件、其中包含通知详细信息。
+
image:fsxn-monitoring-resizing-email-1.png["此图显示了通知可用时收到的电子邮件通知"]

+
image:fsxn-monitoring-resizing-email-2.png["此图显示了通知可用时收到的电子邮件通知"]



=====
====


=== 手动部署

[%collapsible]
====
按照一系列步骤完成此解决方案 的手动部署：

.第1步：克隆GitHub存储库
[%collapsible]
=====
在本地系统上克隆GitHub存储库：

[listing]
----
git clone https://github.com/NetApp-Automation/fsxn-monitoring-auto-resizing.git
----
=====
.第2步：AWS SES SMTP设置(如果无法访问Internet、则需要此设置)
[%collapsible]
=====
如果您要在不访问Internet的情况下部署解决方案 、请执行此步骤(注意：由于正在设置VPC端点、因此会增加相关成本。)

. 导航到AWS控制台>*AWS Simple Email Service (SES)*> SMTP Settings，然后单击*Create SMTP crederations*
. 输入IAM用户名或将其保留为默认值、然后单击创建。保存用户名和密码以供将来使用。
+
image:fsxn-monitoring-resizing-ses-smtp-creds-addition.png["此图显示了AWS SES下的创建SMTP凭据窗口"]



=====
.第3步：为fsxadmin密码创建SSM参数
[%collapsible]
=====
导航到AWS控制台>*参数存储*、然后单击*创建参数*。

[listing]
----
Name: <Any name/path for storing fsxadmin password>
Tier: Standard
Type: SecureString
KMS key source: My current account
  KMS Key ID: <Use the default one selected>
Value: <Enter the password for "fsxadmin" user configured on FSx for ONTAP>
----
单击*创建参数*。

image:fsxn-monitoring-resizing-ssm-parameter.png["此图显示了AWS控制台上的SSM参数创建窗口。"]

如果在不访问Internet的情况下部署解决方案 、则执行相同的步骤来存储SMTP用户名和SMTP密码。否则、跳过添加这2个参数。

=====
.第4步：设置电子邮件服务
[%collapsible]
=====
导航到AWS控制台>*简单电子邮件服务(SES)*、然后单击*创建身份*。

[listing]
----
Identity type: Email address
Email address: <Enter an email address to be used for sending resizing notifications>
----
单击*创建身份*

"发件人电子邮件ID"中提及的电子邮件ID将收到一封电子邮件、要求所有者授权AWS SES使用此电子邮件地址。单击链接以验证电子邮件地址。

image:fsxn-monitoring-resizing-ses.png["此图显示了AWS控制台上的SES身份创建窗口。"]

=====
.第5步：设置VPC端点(如果无法访问Internet、则需要此端点)
[%collapsible]
=====

NOTE: 只有在部署时不能访问Internet时才需要。由于VPC端点的原因、还会产生额外的成本。

. 导航到AWS控制台>* VPC*>*端点*并单击*创建端点*并输入以下详细信息：
+
[listing]
----
Name: <Any name for the vpc endpoint>
Service category: AWS Services
Services: com.amazonaws.<region>.fsx
vpc: <select the vpc where lambda will be deployed>
subnets: <select the subnets where lambda will be deployed>
Security groups: <select the security group>
Policy: <Either choose Full access or set your own custom policy>
----
+
单击创建端点。

+
image:fsxn-monitoring-resizing-vpc-endpoint-create-1.png["此图显示了VPC端点创建窗口"]

+
image:fsxn-monitoring-resizing-vpc-endpoint-create-2.png["此图显示了VPC端点创建窗口"]

. 按照相同的过程创建SES和SSM VPC端点。除将<region> 分别对应于*com.aws.mas.smp.smNT*和*com.惊奇aws.smssm*的服务外，所有参数均与上述相同<region>。


=====
.第6步：创建和设置AWS Lamb编制 函数
[%collapsible]
=====
. 导航到AWS控制台>* AWS Lambda"、然后单击与FSX for ONTAP 位于同一区域的*创建功能*
. 使用默认的*从头开始*作者并更新以下字段：
+
[listing]
----
Function name: <Any name of your choice>
Runtime: Python 3.9
Architecture: x86_64
Permissions: Select "Create a new role with basic Lambda permissions"
Advanced Settings:
  Enable VPC: Checked
    VPC: <Choose either the same VPC as FSx for ONTAP or a VPC that can access both FSx for ONTAP and the internet via a private subnet>
    Subnets: <Choose 2 private subnets which have NAT gateway attached pointing to public subnets with internet gateway and subnets that have internet access>
    Security Group: <Choose a Security Group>
----
+
单击*创建功能*。

+
image:fsxn-monitoring-resizing-lambda-creation-1.png["此图显示了AWS控制台上的Lambda创建窗口。"]

+
image:fsxn-monitoring-resizing-lambda-creation-2.png["此图显示了AWS控制台上的Lambda创建窗口。"]

. 向下滚动到新创建的Lambda函数的*层*部分、然后单击*添加层*。
+
image:fsxn-monitoring-resizing-add-layer-button.png["此图显示了AWS Lambda功能控制台上的添加层按钮。"]

. 单击*层源*下的*创建新层*
. 创建2个层—1个用于请求、1个用于参数化子、然后上传*请求.zip *和*参数化子.zip文件。选择* Python 3.9*作为兼容运行时、然后单击*创建*。
+
image:fsxn-monitoring-resizing-create-layer-paramiko.png["此图显示了AWS控制台上的创建新层窗口。"]

. 导航回AWS Lambda *添加层*>*自定义层*、然后依次添加参数子和请求层。
+
image:fsxn-monitoring-resizing-add-layer-window.png["此图显示了AWS Lambda功能控制台上的添加层窗口。"]

+
image:fsxn-monitoring-resizing-layers-added.png["此图显示了AWS Lambda功能控制台上添加的层。"]

. 导航到Lambda函数的*配置*选项卡、然后单击*常规配置*下的*编辑*。将超时更改为* 5分钟*、然后单击保存。
. 导航到Lambda函数的*权限*选项卡、然后单击分配的角色。在角色的权限选项卡中、单击*添加权限*>*创建实时策略*。
+
.. 单击JSON选项卡、然后从GitHub repo粘贴文件policy.json的内容。
.. 将每次出现的$｛AWS：：AccountId｝替换为您的帐户ID、然后单击*审核策略*
.. 为策略提供一个名称、然后单击*创建策略*


. 在AWS Lambda函数代码源部分中、将* fsxn_monitoring_resizing lambda.py*的内容从git repo*复制到* lambda_Function.py*。
. 创建一个与lambda_function.py级别相同的新文件并将其命名为* vars.py*、然后将vars.py的内容从git repo复制到lambda函数vars.py文件。更新vars.py中的变量值。请参考下面的变量定义、然后单击*部署*：
+
|===


| * 名称 * | * 类型 * | * 问题描述 * 


| * fsxMgmtIp* | string | (必需)从AWS上的ONTAP 的FSX控制台输入"管理端点- IP地址"。 


| * fsxId* | string | (必需)从AWS上的FSX for ONTAP 控制台输入"文件系统ID"。 


| *用户名* | string | (必需)从ONTAP 上的ONTAP 控制台输入FSX for ONTAP 的"FSX管理员用户名"。 


| *调整大小阈值* | 整型 | (必需)输入0-100之间的阈值百分比。此阈值将用于测量存储容量、卷和LUN的使用量、如果超过此阈值的任何使用量百分比增加、则会发生调整大小活动。 


| *发件人电子邮件* | string | (必需)输入在SES上注册的电子邮件ID、lambda功能将使用该ID发送与监控和调整大小相关的通知警报。 


| *收件人电子邮件* | string | (必需)输入要接收警报通知的电子邮件ID。 


| * FSx_password_SSM_parameter* | string | (必需)输入在AWS参数存储中用于存储"fsxadmin"密码的路径名称。 


| *警告通知* | 池 | (必需)将此变量设置为True、以便在存储容量/卷/LUN使用量超过75%但小于阈值时接收通知。 


| *启用_snapshot_deletion* | 池 | (必需)将此变量设置为True、以便为早于"snapshot_age_threshold_in_days"中指定值的快照启用卷级快照删除。 


| * snapshot_age_threshold_in_days* | 整型 | (必需)输入要保留的卷级别快照的天数。任何早于提供值的快照都将被删除、并通过电子邮件通知此快照。 


| *internet_access* | 池 | (必需)如果部署了此兰德的子网可以访问Internet、请将此变量设置为True。否则、请将其设置为False。 


| *SMT_REARAY* | string | (可选)如果"internet_access"变量设置为False、请输入部署了兰德的区域。例如us-east-1 (采用此格式) 


| *SMT_USERNAME_SSM_Parameter* | string | (可选)如果"internet_access"变量设置为False、请输入AWS参数存储中用于存储SMTP用户名的路径名称。 


| *SMT_password_SSM_parameter* | string | (可选)如果"internet_access"变量设置为False、请输入AWS参数存储中用于存储SMTP密码的路径名称。 
|===
+
image:fsxn-monitoring-resizing-lambda-code.png["此图显示了AWS Lambda功能控制台上的lambda代码。"]

. 单击*测试*、创建一个空测试事件、然后运行测试并检查脚本是否运行正常。
. 成功测试后、导航到*配置*>*触发器*>*添加触发器*。
+
[listing]
----
Select a Source: EventBridge
Rule: Create a new rule
Rule name: <Enter any name>
Rule type: Schedule expression
Schedule expression: <Use "rate(1 day)" if you want the function to run daily or add your own cron expression>
----
+
单击添加。

+
image:fsxn-monitoring-resizing-eventbridge.png["此图显示了AWS Lambda功能控制台上的事件网桥创建窗口。"]



=====
====


== 结论

借助提供的解决方案 、可以轻松设置监控解决方案 、以便定期监控ONTAP 存储的FSX、根据用户指定的阈值调整其大小并提供警报机制。这样、使用和监控适用于ONTAP 的FSX的过程就可以无缝地让管理员腾出时间专注于业务关键型活动、同时存储在需要时自动增长。
