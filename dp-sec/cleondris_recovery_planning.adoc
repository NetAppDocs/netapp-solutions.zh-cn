---
sidebar: sidebar 
permalink: dp-sec/cleondris_recovery_planning.html 
keywords: orchestration, multitier, failover, planned migration, plan, 
summary:  
---
= 恢复计划：使用 Cleondris 的 NetApp HCI 灾难恢复
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


[role="lead"]
本节将讨论在发生危机或计划内迁移时成功对应用程序进行故障转移的情况。首先，它将关注保护复杂的多层应用程序，然后再关注简化的应用程序。您可以制定速度较慢或较快的灾难恢复计划，因此本节将举例说明性能最高的计划。



== 多层应用程序

. 从故障转移页面中，选择计划选项卡。
+
image:cleondris_image18.png["错误：缺少图形映像"]

. 最右侧是一个 +Add Failover Group 按钮。
+
image:cleondris_image19.png["错误：缺少图形映像"]

+
在此示例中，我们将此计划称为多层。我们将使用左下角的网络映射将生产环境中使用的虚拟交换机更改为灾难恢复环境中使用的虚拟交换机。

+
image:cleondris_image20.png["错误：缺少图形映像"]

+
上一屏幕截图显示了如何在生产环境中选择网络交换机，在灾难恢复环境中选择网络交换机，使用映射按钮选择网络交换机，然后使用保存。如有必要，您可以具有多个映射。

. 要选择要保护的 VM ，请单击添加故障转移组。
+
由于此计划将保护多层应用程序，因此第一组用于数据库。

+
image:cleondris_image21.png["错误：缺少图形映像"]

+
请注意此示例如何启用 Wait for VMware Tools 。此设置非常重要，因为它有助于确保应用程序正在运行。我们使用 " 添加 VM" 按钮添加数据库 VM 。我们未启用注销源 VM ，因为它会减慢故障转移的速度。现在，我们使用添加故障转移按钮来保护应用程序。

. 对 Web 服务器执行相同的操作。完成此操作后，屏幕类似于以下示例。
+
image:cleondris_image22.png["错误：缺少图形映像"]

+
该计划的重要部分是让所有数据库正常运行，然后启动应用程序，找到数据库并开始工作。然后， Web 服务器将启动，应用程序将完成并正常运行。这种方法是设置此类恢复的最快方法。

. 单击保存，然后继续。




== 用于故障转移的简单或大规模应用程序

VM 的启动顺序非常重要，因此它们可以正常工作；这是上一节所完成的。现在，我们将对一组顺序不重要的 VM 进行故障转移。

我们来创建一个新的故障转移计划，其中一个故障转移组包含多个 VM 。我们仍然需要进行网络映射。

image:cleondris_image23.png["错误：缺少图形映像"]

请注意，此计划包含多个 VM 。它们也会在不同的时间启动，但这是可以的，因为它们不是彼此相关的。



== 计划内迁移

计划内迁移与灾难恢复故障转移类似，但由于它不是灾难恢复情形，因此可以采用略有不同的方式来处理。实践计划内迁移仍不失为一个好方法，但您可以向故障转移组添加一些内容：您可以从源中取消注册虚拟机。这需要花费更多时间，但在计划内迁移中，这并不是一件坏事情。

计划内迁移通常是指迁移到新的数据中心。有时，如果破坏性天气即将来临，但尚未到来，也会使用此功能。



== 计划规划

通过计划，您可以触发一个计划，该计划将负责所有故障转移计划。

计划选项卡包含计划部分。您可以使用 +Add 子计划启动计划并向其添加其他计划。

image:cleondris_image24.png["错误：缺少图形映像"]

在此示例中，计划称为主计划，我们将这两个计划添加到其中。现在，在执行故障转移或测试故障转移时，我们也可以选择主计划。

这种方法很好，因为最好在自己的计划中测试应用程序故障转移。每个计划都更易于进行故障排除和修复，如果运行良好，您可以将其添加到主计划中。



== 脚本支持

您可以在测试故障转移过程中使用脚本，也可以将脚本用于其他各种用途。用途包括：

* 打开防垃圾邮件硬件
* 打开安全硬件
* 填充标志
* 正在更新 IPAM 硬件
* 更改数据库中的语言设置


如果您先编辑计划，然后再编辑故障转移组，则会在脚本下看到相应条目。

image:cleondris_image41.png["错误：缺少图形映像"]

在以下屏幕截图中， Host 一词是指执行脚本的虚拟机。单击编辑按钮以查看编辑脚本窗口：

image:cleondris_image42.png["错误：缺少图形映像"]

在将脚本复制并粘贴到此对话框之前，应确保对其进行测试。您还应在 " 组顺序 " 字段中选择 " 发布 " 。请确保使用正确的凭据。

如果您在执行之后继续执行，则以下屏幕截图将指示脚本已成功运行。

image:cleondris_image43.png["错误：缺少图形映像"]

如果退出代码不是 0 ，则脚本未成功。



=== 脚本故障排除

如果脚本无法正确执行，请检查以下问题：

* VMware Tools 一次仅允许运行一个外部进程。因此，如果 VMware Tools 正在自行更新，则脚本将不会执行。如果将 VM 设置为自动升级 VMware Tools ，则可能会发生这种情况。此操作可在 VM 设置 > VM 选项 > VMware 工具中完成。
* 检查凭据问题。
* 检查脚本问题，例如需要人工输入的提示符或其他功能。


最佳做法是运行仅执行基本任务的简单脚本。您可能还需要包含日志文件以进行故障排除。



== 环境变量

环境变量允许正在运行的脚本从环境中提取信息，无论该脚本是在生产站点还是灾难恢复站点运行。可以在编辑故障转移组对话框中输入环境变量。您可以先编辑计划，然后编辑故障转移组。

image:cleondris_image44.png["错误：缺少图形映像"]

请注意，这些环境变量不在我们通常认为的环境中，您无法使用 set 命令来查看它们。要查看完整的变量列表，请从以下屏幕截图运行脚本。此脚本包含 `Get-Variable * > c ： \utils\var_log.txt` 以捕获所有变量。

image:cleondris_image45.png["错误：缺少图形映像"]

此选项将列出可用的 50 多个变量以及您添加的任何变量，这些变量将显示在列表末尾。
